<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.SingerMapper">
	<sql id="page">limit #{pageStart},#{pageSize}</sql>


	<select id="searchSingerCount" resultType="java.lang.Integer" parameterType="java.util.Map">
	select count(distinct(creator_id)) 
		 FROM  room  r
		  <where>
		    <if test="startTime != null">
		    	<![CDATA[
					AND DATE_FORMAT(r.create_at, '%Y-%m-%d') >= #{startTime,jdbcType=VARCHAR} 
				]]>
		    </if>
		    <if test="endTime != null">
		    	<![CDATA[
		    		AND DATE_FORMAT(r.create_at, '%Y-%m-%d') <= #{endTime,jdbcType=VARCHAR} 
				]]>
		    </if>
		    	<if test="userType != null">
			    	<![CDATA[
			    		AND creator_id IN (SELECT DISTINCT(dest_id) FROM  sing_vote WHERE user_type=#{userType}) 
					]]>
			    </if>
		</where>
	</select>
	
	<select id="searchSinger" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT `creator_id` as uid, (select name from  ruser where id=r.creator_id ) as name,SUM(duration) as shichang , SUM(point_number) as jinbi ,SUM(uv) as renshu ,
		 (SELECT SUM(popularity) FROM sing_vote WHERE dest_id=r.creator_id
		  <if test="startTime != null">
		    	<![CDATA[
					AND DATE_FORMAT(create_at, '%Y-%m-%d') >=#{startTime,jdbcType=VARCHAR} 
				]]>
		    </if>
		    <if test="endTime != null">
		    	<![CDATA[
		    		AND DATE_FORMAT(create_at, '%Y-%m-%d') <=#{endTime,jdbcType=VARCHAR} 
				]]>
		    </if>
		 
		  ) AS popularity,
		(SELECT COUNT(*) FROM sing_vote WHERE dest_id=r.creator_id  AND TYPE=1
		 <if test="startTime != null">
				    	<![CDATA[
							AND DATE_FORMAT(create_at, '%Y-%m-%d') >= #{startTime,jdbcType=VARCHAR}
						]]>
				    </if>
				    <if test="endTime != null">
				    	<![CDATA[
				    		AND DATE_FORMAT(create_at, '%Y-%m-%d') <= #{endTime,jdbcType=VARCHAR}
						]]>
				    </if>
		) AS changnei,
		(SELECT COUNT(*) FROM sing_vote WHERE dest_id=r.creator_id  AND TYPE=3
		     <if test="startTime != null">
				    	<![CDATA[
							AND DATE_FORMAT(create_at, '%Y-%m-%d') >= #{startTime,jdbcType=VARCHAR}
						]]>
				    </if>
				    <if test="endTime != null">
				    	<![CDATA[
				    		AND DATE_FORMAT(create_at, '%Y-%m-%d') <= #{endTime,jdbcType=VARCHAR}
						]]>
				    </if>
		) AS changwai
    FROM  room  r
  
	 <where>
			    <if test="startTime != null">
			    	<![CDATA[
						AND DATE_FORMAT(r.create_at, '%Y-%m-%d') >= #{startTime,jdbcType=VARCHAR}
					]]>
			    </if>
			    <if test="endTime != null">
			    	<![CDATA[
			    		AND DATE_FORMAT(r.create_at, '%Y-%m-%d') <= #{endTime,jdbcType=VARCHAR} 
					]]>
			    </if>
			    
			    <if test="userType != null">
			    	<![CDATA[
			    		AND creator_id IN (SELECT DISTINCT(dest_id) FROM  sing_vote WHERE user_type=#{userType}) 
					]]>
			    </if>
	</where>			  
	GROUP BY creator_id
	</select>
	
	
	<sql id="searchRicherWhere">
		 <where>
				    <if test="startTime != null">
				    	<![CDATA[
							AND DATE_FORMAT(c.create_at, '%Y-%m-%d') >= #{startTime,jdbcType=VARCHAR}
						]]>
				    </if>
				    <if test="endTime != null">
				    	<![CDATA[
				    		AND DATE_FORMAT(c.create_at, '%Y-%m-%d') <= #{endTime,jdbcType=VARCHAR} 
						]]>
				    </if>
		</where>		
	</sql>
	<select id="searchRicher" resultType="java.util.Map" parameterType="java.util.Map">
			SELECT `sender` as uid, (select name from  ruser where id=c.sender ) as name,
			SUM(diamond_count) as jindou 
	    FROM  consume_record  c
		<include refid="searchRicherWhere"></include>	  
		GROUP BY sender
		order by  jindou desc
	</select>
	<select id="searchRicherCount" resultType="java.lang.Integer" parameterType="java.util.Map">
			SELECT count(distinct(sender)) 
	    FROM  consume_record  c
		<include refid="searchRicherWhere"></include>	  
		
	</select>
</mapper>
