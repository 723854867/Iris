<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.FeedbackDAO">

	<sql id="where_sql">
		<where>
			<if test="content !=null and content !=''">
				AND f.content LIKE CONCAT('%',#{content,jdbcType=VARCHAR},'%')
			</if>
			<if test="dataFrom !=  null and dataFrom !=''">
				AND f.data_from = #{dataFrom,jdbcType=VARCHAR}
			</if>
			<if test="startTime !=null and startTime != ''">
				<![CDATA[ AND DATE_FORMAT(f.create_at, '%Y-%m-%d')  >= #{startTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="endTime !=null and endTime != ''">
				<![CDATA[ AND DATE_FORMAT(f.create_at, '%Y-%m-%d')  <= #{endTime,jdbcType=TIMESTAMP} ]]>
			</if>
		</where>
	</sql>

	<select id="selectFeedback" resultType="map">
		select f.id as id,f.contact as contact,f.creator_id as creatorId,f.content as content,f.create_at as createDate,
		f.status,f.data_from AS dataFrom
		from feedback f
		<include refid="where_sql"/>
		order by f.create_at desc
		limit #{pageStart},#{pageSize}
	</select>

	<select id="selectFeedbackList" resultType="com.busap.vcs.data.model.FeedbackDisplay" parameterType="java.util.Map">
		select f.id as id,f.contact as contact,f.creator_id as creatorId,f.content as content,f.create_at as createDate,
		f.status,f.data_from AS dataFrom,f.app_version as appVersion
		from feedback f
		<include refid="where_sql"/>
		order by f.create_at desc
	</select>

	<select id="selectFeedbackCount" resultType="integer">
		select count(f.id) from feedback f
		<include refid="where_sql"/>
	</select>

	<select id="selectInIds" resultType="com.busap.vcs.data.model.FeedbackDisplay" parameterType="java.util.Map">
		SELECT
		f.id,
		f.content,
		f.contact,
		f.create_at AS createDate,
		f.status,
		f.data_from AS dataFrom,
		r.phone
		FROM
		feedback f
		LEFT JOIN ruser r ON r.id = f.creator_id
		WHERE f.id IN
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
		ORDER BY id DESC
	</select>

	<update id="updateFeedbackInIds" parameterType="java.util.List">
		UPDATE feedback
		<set>
			status = 1
		</set>
		WHERE id IN
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item.id,jdbcType=VARCHAR}
		</foreach>
	</update>

	<select id="exportFeedBackList" resultType="com.busap.vcs.data.model.ExportFeedback" parameterType="java.util.Map">
		select f.content as content,f.create_at as createDate,f.creator_id as creatorId,f.contact as contact,
		f.data_from AS dataFrom,CASE f.status WHEN 1 THEN '已跟踪' ELSE '未跟踪' END AS status
		from feedback f
		<include refid="where_sql"/>
		order by f.create_at desc
	</select>

</mapper>