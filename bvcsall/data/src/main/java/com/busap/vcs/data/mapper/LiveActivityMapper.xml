<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.LiveActivityDAO">



    <sql id="page">limit #{pageStart},#{pageSize}</sql>


    <select id="searchActivitysCount" resultType="Integer">
    	select count(id)
		FROM live_activity
		<include refid="where_sql"/>
    </select>




	<!--活动管理列表查询-->
	<sql id="where_sql">
		<where>
			<if test="id != null">
				AND a.id = #{id}
			</if>
			<if test="title !=null and title != ''">
				AND a.title like CONCAT('%',#{title},'%')
			</if>
			<if test="startTime !=null and startTime != ''">
				<![CDATA[ AND DATE_FORMAT(a.modify_at, '%Y-%m-%d')  >= #{startTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="endTime !=null and endTime != ''">
				<![CDATA[ AND DATE_FORMAT(a.modify_at, '%Y-%m-%d')  <= #{endTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="order_num !=null">
				AND a.order_num = #{orderNum}
			</if>
			<if test="status !=null">
				AND a.status = #{status}
			</if>
			<if test="groupType !=null">
				AND a.group_type = #{groupType}
			</if>
			<if test="source != null and source != ''">
				AND a.source = #{source}
			</if>
		</where>
	</sql>

	<select id="selectActivities" parameterType="java.util.Map" resultType="com.busap.vcs.data.model.LiveActivityDisplay">
		SELECT
		a.id,
		a.title,
		a.cover,
		a.create_at AS createDate,
		a.order_num AS orderNum,
		a.`status`,
		a.`type`,
		a.gift_ids AS giftIds,
		a.show_count_of_top AS showCountOfTop,
		a.start_time AS startTime,
		a.end_time AS endTime,
		a.description

		FROM live_activity a
		<include refid="where_sql"/>
		ORDER BY a.order_num ASC,a.create_at desc
	</select>

<!--	<select id="selectActivityCount" resultType="java.lang.Integer" parameterType="map">
		SELECT
		COUNT(1)
		FROM activity a
		<include refid="where_sql"/>
	</select>-->

	<insert id="insert" parameterType="com.busap.vcs.data.entity.Activity" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO activity
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="title != null and title != ''">
				title,
			</if>
			<if test="cover != null and cover != ''">
				cover,
			</if>
			<if test="createDateStr != null">
				create_at,
			</if>
			<if test="creatorId != null">
				creator_id,
			</if>
			<if test="modifyDate != null">
				modify_at,
			</if>
			<if test="description != null and description != ''">
				description,
			</if>
			<if test="order_num != null">
				order_num,
			</if>
			<if test="dataFrom != null and dataFrom != ''">
				data_from,
			</if>
			<if test="groupType != null">
				group_type,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="bannerPic != null and bannerPic != ''">
				banner_pic,
			</if>
			<if test="videoCoverPic != null and videoCoverPic != ''">
				video_cover_pic,
			</if>
			<if test="playkey != null and playkey != ''">
				playkey,
			</if>
			<if test="bannerDescription != null and bannerDescription != ''">
				banner_description,
			</if>
			<if test="tags != null and tags != ''">
				tags,
			</if>
			<if test="rusers != null and rusers != ''">
				rusers,
			</if>
			<if test="vips != null and vips != ''">
				vips,
			</if>
			<if test="source != null and source != ''">
				source,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="title != null and title != ''">
				#{title,jdbcType=VARCHAR},
			</if>
			<if test="cover != null and cover != ''">
				#{cover,jdbcType=VARCHAR},
			</if>
			<if test="createDateStr != null">
				#{createDateStr,jdbcType=TIMESTAMP},
			</if>
			<if test="creatorId != null">
				#{creatorId,jdbcType=INTEGER},
			</if>
			<if test="modifyDate != null">
				#{modifyDate,jdbcType=TIMESTAMP},
			</if>
			<if test="description != null and description != ''">
				#{description,jdbcType=VARCHAR},
			</if>
			<if test="order_num != null">
				#{order_num,jdbcType=INTEGER},
			</if>
			<if test="dataFrom != null and dataFrom != ''">
				#{dataFrom,jdbcType=VARCHAR},
			</if>
			<if test="groupType != null">
				#{groupType,jdbcType=INTEGER},
			</if>
			<if test="status != null">
				#{status,jdbcType=INTEGER},
			</if>
			<if test="bannerPic != null and bannerPic != ''">
				#{bannerPic,jdbcType=VARCHAR},
			</if>
			<if test="videoCoverPic != null and videoCoverPic != ''">
				#{videoCoverPic,jdbcType=VARCHAR},
			</if>
			<if test="playkey != null and playkey != ''">
				#{playkey,jdbcType=VARCHAR},
			</if>
			<if test="bannerDescription != null and bannerDescription != ''">
				#{bannerDescription,jdbcType=VARCHAR},
			</if>
			<if test="tags != null and tags != ''">
				#{tags,jdbcType=VARCHAR},
			</if>
			<if test="rusers != null and rusers != ''">
				#{rusers,jdbcType=VARCHAR},
			</if>
			<if test="vips != null and vips != ''">
				#{vips,jdbcType=VARCHAR},
			</if>
			<if test="source != null and source != ''">
				#{source,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>

	<update id="update" parameterType="com.busap.vcs.data.entity.Activity">
		UPDATE activity
		<set>
			<if test="id != null">
				id = #{id,jdbcType=INTEGER},
			</if>
			<if test="title != null and title != ''">
				title = #{title,jdbcType=VARCHAR},
			</if>
			<if test="cover != null and cover != ''">
				cover = #{cover,jdbcType=VARCHAR},
			</if>
			<if test="createDateStr != null">
				createDateStr = #{createDateStr,jdbcType=TIMESTAMP},
			</if>
			<if test="creatorId != null">
				creatorId = #{creatorId,jdbcType=INTEGER},
			</if>
			<if test="modifyDate != null">
				modifyDate = #{modifyDate,jdbcType=TIMESTAMP},
			</if>
			<if test="description != null and description != ''">
				description = #{description,jdbcType=VARCHAR},
			</if>
			<if test="order_num != null">
				order_num = #{order_num,jdbcType=INTEGER},
			</if>
			<if test="dataFrom != null and dataFrom != ''">
				dataFrom = #{dataFrom,jdbcType=VARCHAR},
			</if>
			<if test="groupType != null">
				groupType = #{groupType,jdbcType=INTEGER},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="bannerPic != null and bannerPic != ''">
				bannerPic = #{bannerPic,jdbcType=VARCHAR},
			</if>
			<if test="videoCoverPic != null and videoCoverPic != ''">
				videoCoverPic = #{videoCoverPic,jdbcType=VARCHAR},
			</if>
			<if test="playkey != null and playkey != ''">
				playkey = #{playkey,jdbcType=VARCHAR},
			</if>
			<if test="bannerDescription != null and bannerDescription != ''">
				bannerDescription = #{bannerDescription,jdbcType=VARCHAR},
			</if>
			<if test="tags != null and tags != ''">
				tags = #{tags,jdbcType=VARCHAR},
			</if>
			<if test="rusers != null and rusers != ''">
				rusers = #{rusers,jdbcType=VARCHAR},
			</if>
			<if test="vips != null and vips != ''">
				vips = #{vips,jdbcType=VARCHAR},
			</if>
			<if test="source != null and source != ''">
				source = #{source,jdbcType=VARCHAR},
			</if>
		</set>
		WHERE id = #{id,jdbcType=BIGINT}
	</update>

	<update id="batchOnline" parameterType="java.util.List">
			UPDATE activity
		    	<set>
			    	status = 1
		  	    </set>
			WHERE id IN
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
                #{item.id,jdbcType=INTEGER}
            </foreach>
	</update>

    <update id="batchOffline" parameterType="java.util.List">
            UPDATE activity
            <set>
                status = 0
            </set>
            WHERE id IN
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
				   #{item.id,jdbcType=INTEGER}
            </foreach>
    </update>

    <select id="selectBatchOnline" resultType="com.busap.vcs.data.entity.Activity">
        SELECT
        id
        FROM
        activity
        WHERE id IN
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

	<delete id="deleteActivity" parameterType="Long">
		DELETE FROM activity
		WHERE id = #{id}
	</delete>

	<select id="selectByPrimaryKey" resultType="com.busap.vcs.data.entity.Activity" parameterType="Long">
		SELECT
		id,
		order_num
		FROM activity WHERE id = #{id}
	</select>

	<update id="updateSort" parameterType="java.util.Map">
		UPDATE activity
		<set>
			order_num= #{orderNum}
		</set>
		WHERE id = #{id}
	</update>

	<select id="selectActivityByOrderNum" parameterType="java.util.Map" resultType="com.busap.vcs.data.entity.Activity">
		SELECT
		id,
		order_num
		FROM
		activity
		<if test="ASC != '' and ASC != null">
			WHERE order_num <![CDATA[ > ]]> #{orderNum}
			ORDER BY order_num ASC
		</if>
		<if test="DESC != '' and DESC != null">
			WHERE order_num <![CDATA[ < ]]> #{orderNum}
			ORDER BY order_num DESC
		</if>
		<if test="MAX != '' and MAX != null">
			ORDER BY order_num DESC
		</if>
		LIMIT 1
	</select>

	<select id="selectActivityVideoCount" parameterType="java.util.Map" resultType="java.lang.Long">
		SELECT
		COUNT(*)
		FROM activity_video av
		LEFT JOIN video v ON v.id = av.videoid
		left JOIN ruser r ON r.id = v.creator_id
		WHERE r.type = #{type}
		AND v.flow_stat != 'delete'
		AND av.activityid = #{activityId}
	</select>

	<select id="selectActivityList" parameterType="java.util.Map" resultType="com.busap.vcs.data.entity.Activity">
		SELECT
		a.id,
		a.title,
		a.cover,
		a.create_at AS createDate,
		a.order_num,
		a.`status`,
		a.playkey,
		a.banner_pic AS bannerPic,
		a.video_cover_pic AS videoCoverPic,
		a.create_at AS createDateStr,
		a.group_type AS groupType,
		a.description,
		a.source
		FROM activity a
		<where>
			<if test="source != null and source !=''">
				<choose>
					<when test="source == 'android'">
						a.source = "android" OR a.source = "all"
					</when>
					<when test="source == 'ios'">
						a.source = "ios" OR a.source = "all"
					</when>
				</choose>
			</if>
		</where>
		ORDER BY a.order_num ASC,a.create_at DESC
		<include refid="page"/>
	</select>

	<select id="selectLiveActivityById" resultType="com.busap.vcs.data.entity.LiveActivity" parameterType="java.lang.Long">
		SELECT
		id,
		title,
		cover,
		create_at AS createDate,
		order_num AS orderNum,
		`status`,
		gift_ids AS giftIds,
		show_count_of_top AS showCountOfTop,
		start_time AS startTime,
		end_time AS endTime,
		description
		FROM live_activity WHERE id = #{id,jdbcType=BIGINT}
	</select>

</mapper>