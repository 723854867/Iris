<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.UserDao">

	<sql id="page">
		LIMIT #{pageStart},#{pageSize}
	</sql>

	<sql id="where_sql">
		<where>
			<if test="group != null">
				AND r.id = #{group}
			</if>
			<if test="username !=null and username != ''">
				AND u.username like CONCAT('%',#{username},'%')
			</if>
			<if test="phone !=null and phone != ''">
				AND u.phone like CONCAT('%',#{phone},'%')
			</if>
			<if test="email !=null and email != ''">
				AND u.email like CONCAT('%',#{email},'%')
			</if>
			<if test="isLocked != null">
				AND u.is_locked = #{isLocked}
			</if>
			<if test="isEnabled != null">
				AND u.is_enabled = #{isEnabled}
			</if>
		</where>
	</sql>

	<select id="selectUserInfo" resultType="com.busap.vcs.data.entity.User" parameterType="java.util.Map">
		SELECT
		id,
		name,
		create_at AS createDate,
		department,
		email
		FROM
		user
		WHERE
		is_locked = 0 AND email IS NOT NULL
		ORDER BY id DESC
	</select>

	<select id="select" resultType="com.busap.vcs.data.model.UserDisplay" parameterType="java.util.Map">
		SELECT
		u.id,
		u.create_at AS createDate,
		u.activation_code AS activationCode,
		u.department,
		u.email,
		u.is_enabled AS isEnabled,
		u.is_locked AS isLocked,
		u.locked_date AS lockedDate,
		u.login_date AS loginDate,
		u.login_failure_count AS loginFailureCount,
		u.login_ip AS loginIp,
		u.name,
		u.password,
		u.phone,
		u.type,
		u.username,
		u.creator_id AS createorId,
		u.data_from AS dataFrom,
		r.name AS groupName,
		ur.user
		FROM
		user u
		LEFT JOIN user_role ur ON ur.user = u.id
		LEFT JOIN role r ON r.id = ur.roles
		<include refid="where_sql"/>
		ORDER BY u.id DESC
    </select>

	<select id="selectCount" resultType="java.lang.Integer" parameterType="java.util.Map">
		SELECT
		COUNT(1)
		FROM
		user u
		LEFT JOIN user_role ur ON ur.user = u.id
		LEFT JOIN role r ON r.id = ur.roles
		<include refid="where_sql"/>
	</select>

	<update id="update" parameterType="com.busap.vcs.data.entity.User">
		UPDATE user
		<set>
			<if test="loginIp != null and loginIp != ''">
				login_ip = #{loginIp,jdbcType=VARCHAR},
			</if>
		</set>
		WHERE id = #{id,jdbcType=BIGINT}
	</update>

</mapper>