<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.ActivityVideoDao">

    <sql id="where_sql">
        <if test="activityId != null">
            AND av.activityid = #{activityId}
        </if>
        <if test="dataFrom != null and dataFrom != ''">
            AND v.data_from = #{dataFrom}
        </if>
        <if test="description !=null and description != ''">
            AND v.description LIKE CONCAT('%',#{description},'%')
        </if>
        <if test="startTime !=null and startTime != ''">
            <![CDATA[ AND DATE_FORMAT(v.create_at, '%Y-%m-%d')  >= #{startTime,jdbcType=TIMESTAMP} ]]>
        </if>
        <if test="endTime !=null and endTime != ''">
            <![CDATA[ AND DATE_FORMAT(v.create_at, '%Y-%m-%d')  <= #{endTime,jdbcType=TIMESTAMP} ]]>
        </if>
        <choose>
            <when test="user != null">
                <if test="user == 1">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.id = #{userKeyword}
                    </if>
                </if>
                <if test="user == 2">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.username LIKE CONCAT('%',#{userKeyword},'%')
                    </if>
                </if>
                <if test="user == 3">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.name LIKE CONCAT('%',#{userKeyword},'%')
                    </if>
                </if>
                <if test="user == 4">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.phone LIKE CONCAT('%',#{userKeyword},'%')
                    </if>
                </if>
            </when>
        </choose>
    </sql>

    <select id="selectActivityVideos" parameterType="java.util.Map"
            resultType="com.busap.vcs.data.model.ActivityVideoDisplay">
        SELECT
        av.id,
        v.name,
        av.activityid AS activityId,
        av.videoid AS videoId,
        av.order_num AS orderNum,
        v.create_at AS createDateStr,
        v.description,
        v.video_pic AS videoPic,
        v.video_list_pic AS videoListPic,
        v.tag,
        v.creator_id AS creatorId,
        v.praise_count AS praiseCount,
        v.favorite_count AS favoriteCount,
        v.evaluation_count AS evaluationCount,
        a.forwardCount,
        r.username,
        r.name AS uname,
        r.phone,
        r.id AS userId,
        v.play_key AS playKey
        FROM
        activity_video av
        LEFT JOIN video v ON v.id = av.videoid
        LEFT JOIN ruser r ON r.id = v.creator_id
        LEFT JOIN
        (
        SELECT f.video_id,COUNT(1) AS forwardCount FROM forward f
        LEFT JOIN video v
        ON v.id = f.video_id
        GROUP BY f.video_id
        ) a ON a.video_id = v.id
        WHERE v.id IS NOT NULL AND <![CDATA[ v.flow_stat<>'delete' ]]>
        <include refid="where_sql"/>
        ORDER BY av.order_num DESC,v.create_at DESC
    </select>

<!--    <select id="selectActivityVideoCount" resultType="java.lang.Integer" parameterType="map">
        SELECT
        COUNT(1)
        FROM
        activity_video av
        LEFT JOIN video v ON v.id = av.videoid
        LEFT JOIN ruser r ON r.id = v.creator_id
        LEFT JOIN
        (
        SELECT f.video_id,COUNT(1) AS forwardCount FROM forward f
        LEFT JOIN video v
        ON v.id = f.video_id
        GROUP BY f.video_id
        ) a ON a.video_id = v.id
        WHERE v.id IS NOT NULL AND <![CDATA[ v.flow_stat<>'delete' ]]>
        <include refid="where_sql"/>
    </select>-->

    <select id="selectActivityVideoByActivityId" parameterType="java.util.Map"
            resultType="com.busap.vcs.data.entity.ActivityVideo">
		SELECT
		id,
		order_num AS orderNum,
		videoid,
		activityid
		FROM
		activity_video
		WHERE
		activityid = #{activityId}
		ORDER BY order_num DESC
	</select>

    <update id="updateSort" parameterType="java.util.Map">
        UPDATE activity_video
        <set>
            order_num= #{orderNum}
        </set>
        WHERE id = #{id}
    </update>

    <select id="selectActivityVideoByOrderNum" parameterType="java.util.Map" resultType="com.busap.vcs.data.entity.ActivityVideo">
        SELECT
        av.id,
        av.order_num AS orderNum
        FROM
        activity_video av
        LEFT JOIN video v ON v.id = av.videoid
        <if test="ASC != '' and ASC != null">
            WHERE av.order_num <![CDATA[ > ]]> #{orderNum}
            AND av.activityid = #{activityId}
            AND <![CDATA[ v.flow_stat<>'delete' ]]>
            ORDER BY av.order_num ASC
        </if>
        <if test="DESC != '' and DESC != null">
            WHERE av.order_num <![CDATA[ < ]]> #{orderNum}
            AND av.activityid = #{activityId}
            AND <![CDATA[ v.flow_stat<>'delete' ]]>
            ORDER BY av.order_num DESC
        </if>
        <if test="MAX != '' and MAX != null">
            WHERE av.activityid = #{activityId}
            AND <![CDATA[ v.flow_stat<>'delete' ]]>
            ORDER BY av.order_num DESC
        </if>
        LIMIT 1
    </select>

    <select id="selectByPrimaryKey" resultType="com.busap.vcs.data.entity.ActivityVideo" parameterType="Long">
        SELECT
        av.id,
        av.order_num AS orderNum
        FROM activity_video av
        LEFT JOIN video v ON v.id = av.videoid
        WHERE av.id = #{id} AND <![CDATA[ v.flow_stat<>'delete' ]]>
    </select>

    <delete id="deleteInPrimaryKeys" parameterType="java.lang.String">
        DELETE FROM activity_video
        WHERE id IN
        <foreach item="idItem" collection="array" open="(" separator="," close=")">
            #{idItem}
        </foreach>
    </delete>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        DELETE FROM activity_video WHERE id = #{id}
    </delete>

    <select id="selectActivityVideosByTime" parameterType="java.util.Map" resultType="com.busap.vcs.data.model.ExportActivityVideo">
        SELECT v.description AS videoDescription,
        v.create_at AS createTime,
        r.username,
        r.id,
        r.name,
        r.phone,
        tb.videoCount,
        v.praise_count AS praiseCount,
        v.evaluation_count AS evaluationCount,
        v.play_count AS playPoint
        FROM activity_video av
        INNER JOIN video v ON v.id = av.videoid
        INNER JOIN activity a ON a.id = av.activityid
        INNER JOIN ruser r ON r.id = v.creator_id
        LEFT JOIN
        (
        select t.videoCount,t.id from
        (
        SELECT
        count(r.id) AS videoCount,r.id
        FROM activity_video av
        INNER JOIN video v ON v.id = av.videoid
        INNER JOIN activity a ON a.id = av.activityid
        INNER JOIN ruser r ON r.id = v.creator_id
        WHERE a.id IS NOT NULL AND v.id IS NOT NULL AND v.flow_stat != 'delete'
        AND av.activityid = #{activityId,jdbcType=BIGINT}
        GROUP BY r.id
        ) t
        ) tb ON tb.id = r.id
        WHERE a.id IS NOT NULL AND v.id IS NOT NULL AND v.flow_stat != 'delete'
        AND av.activityid = #{activityId,jdbcType=BIGINT}
        <if test="startTime !=null and startTime != ''">
            <![CDATA[ AND DATE_FORMAT(v.create_at, '%Y-%m-%d')  >= #{startTime,jdbcType=TIMESTAMP} ]]>
        </if>
        <if test="endTime !=null and endTime != ''">
            <![CDATA[ AND DATE_FORMAT(v.create_at, '%Y-%m-%d')  <= #{endTime,jdbcType=TIMESTAMP} ]]>
        </if>
        ORDER BY v.praise_count DESC,v.play_count DESC
    </select>

</mapper>
