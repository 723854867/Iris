<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.MusicDAO">

	<select id="selectAllMusic" resultType="com.busap.vcs.data.vo.MusicVO">
		select a.id as id,unix_timestamp(a.create_at)*1000
		as createDate,a.creator_id as creatorId,unix_timestamp(a.modify_at)*1000 as modifyDate,a.name as
		name,a.url as url,a.size as size,a.data_from as dataFrom,a.type_id as typeId,a.status as status,a.order_number as orderNumber,
		a.description as description,a.face_url as faceUrl,b.type_name as typeName from music a left join music_type b
		on a.type_id = b.id where a.status=1 order by a.order_number desc,a.create_at desc
	</select>

	<sql id="where_sql">
		<where>
			<if test="name != null and name != ''">
				AND m.name LIKE CONCAT('%',#{name,jdbcType=VARCHAR},'%')
			</if>
			<if test="creatorId != null">
				AND m.creator_id = #{creatorId,jdbcType=INTEGER}
			</if>
			<if test="status != null">
				AND m.status = #{status,jdbcType=INTEGER}
			</if>
			<if test="typeId != null">
				AND m.type_id = #{typeId,jdbcType=INTEGER}
			</if>
			<if test="startDate !=null and startDate != ''">
				<![CDATA[ AND DATE_FORMAT(m.create_at, '%Y-%m-%d')  >= #{startDate,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="endDate !=null and endDate != ''">
				<![CDATA[ AND DATE_FORMAT(m.create_at, '%Y-%m-%d')  <= #{endDate,jdbcType=TIMESTAMP} ]]>
			</if>
		</where>
	</sql>

	<select id="selectMusics" resultType="com.busap.vcs.data.model.MusicDisplay" parameterType="java.util.Map">
		SELECT
		m.id,
		m.create_at AS createDate,
		m.name,
		m.description,
		m.face_url AS faceUrl,
		m.url,
		m.status,
		m.type_id AS typeId,
		mt.type_name AS typeName,
		m.order_number as orderNumber,
		u.username AS createPerson
		FROM music m
		LEFT JOIN music_type mt ON mt.id = m.type_id
		LEFT JOIN user u ON u.id = m.creator_id
		<include refid="where_sql"/> 
		order by m.order_number desc,m.create_at desc
	</select>

<!--	<select id="selectMusicCount" resultType="java.lang.Integer" parameterType="map">
		SELECT
		COUNT(1)
		FROM music m
		LEFT JOIN music_type mt ON mt.id = m.type_id
		LEFT JOIN user u ON u.id = m.creator_id
		<include refid="where_sql"/>
	</select>-->

	<delete id="deleteInMusicId" parameterType="java.lang.String">
		DELETE FROM music WHERE id IN
		<foreach item="item" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
	</delete>

	<update id="updateStatusInMusicIds" parameterType="java.lang.String">
		UPDATE music
		<set>
			status = 0
		</set>
		WHERE id IN
		<foreach item="item" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
	</update>

	<update id="update" parameterType="com.busap.vcs.data.entity.Music">
		UPDATE music
		<set>
			<if test="creatorId != null">
				creator_id = #{creatorId,jdbcType=INTEGER},
			</if>
			modify_at = now(),
			<if test="name != null and name !=''">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="orderNumber != null and orderNumber !=''">
				order_number = #{orderNumber,jdbcType=INTEGER},
			</if>
			<if test="size != null">
				size = #{size,jdbcType=INTEGER},
			</if>
			<if test="url != null and url != ''">
				url = #{url,jdbcType=VARCHAR},
			</if>
			<if test="typeId != null">
				type_id = #{typeId,jdbcType=INTEGER},
			</if>
			<if test="description !=null and description != ''">
				description = #{description,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="faceUrl !=null and faceUrl != ''">
				face_url = #{faceUrl,jdbcType=VARCHAR},
			</if>
		</set>
		WHERE id = #{id,jdbcType=BIGINT}
	</update>

	<select id="selectByPrimaryKey" resultType="com.busap.vcs.data.entity.Music" parameterType="java.lang.Long">
		SELECT
		id,
		name,
		description,
		status,
		type_id AS typeId,
		url,
		face_url AS faceUrl,
		order_number AS orderNumber
		FROM music
		WHERE id = #{id,jdbcType=BIGINT}
	</select>

	<insert id="insert" parameterType="com.busap.vcs.data.entity.Music" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO music
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			create_at,
			<if test="creatorId != null">
				creator_id,
			</if>
			<if test="name != null and name != ''">
				name,
			</if>
			<if test="orderNumber != null and orderNumber != ''">
				order_number,
			</if>
			<if test="size != null">
				size,
			</if>
			<if test="url != null and url != ''">
				url,
			</if>
			<if test="typeId != null">
				type_id,
			</if>
			<if test="description != null and description != ''">
				description,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="faceUrl != null and faceUrl != ''">
				face_url,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			now(),
			<if test="creatorId != null">
				#{creatorId,jdbcType=INTEGER},
			</if>
			<if test="name != null and name != ''">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="orderNumber != null and orderNumber != ''">
				#{orderNumber,jdbcType=INTEGER},
			</if>
			<if test="size != null">
				#{size,jdbcType=INTEGER},
			</if>
			<if test="url != null and url != ''">
				#{url,jdbcType=VARCHAR},
			</if>
			<if test="typeId != null">
				#{typeId,jdbcType=INTEGER},
			</if>
			<if test="description != null and description != ''">
				#{description,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=INTEGER},
			</if>
			<if test="faceUrl != null and faceUrl != ''">
				#{faceUrl,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>

	<select id="selectMusicType" parameterType="map" resultType="com.busap.vcs.data.entity.MusicType">
		SELECT
		id,
		create_at AS createDateStr,
		creator_id AS creatorId,
		data_from AS dataFrom,
		modify_at AS modifyDate,
		type_name AS typeName
		FROM music_type ORDER BY create_at DESC
	</select>

	<select id="selectMusicTypeByName" parameterType="java.lang.String" resultType="com.busap.vcs.data.entity.MusicType">
		SELECT
		id,
		create_at AS createDateStr,
		creator_id AS creatorId,
		data_from AS dataFrom,
		modify_at AS modifyDate,
		type_name AS typeName
		FROM music_type
		WHERE type_name = #{typeName,jdbcType=VARCHAR} LIMIT 1
	</select>

	<insert id="insertMusicType" parameterType="com.busap.vcs.data.entity.MusicType" useGeneratedKeys="true" keyProperty="id">
	insert into music_type (id, create_at, creator_id,
    data_from, type_name)
    values (#{id,jdbcType=BIGINT}, #{createDateStr,jdbcType=TIMESTAMP}, #{creatorId,jdbcType=BIGINT},
    #{dataFrom,jdbcType=VARCHAR}, #{typeName,jdbcType=VARCHAR})
	</insert>

	<delete id="deleteMusicType" parameterType="java.lang.Long">
	delete from music_type
    where id = #{id,jdbcType=BIGINT}
	</delete>

	<select id="selectMusicTypeByPrimaryKey" parameterType="java.lang.Long" resultType="com.busap.vcs.data.entity.MusicType">
		SELECT
		id,
		create_at AS createDateStr,
		creator_id AS creatorId,
		data_from AS dataFrom,
		modify_at AS modifyDate,
		type_name AS typeName
		FROM music_type
		WHERE id = #{id,jdbcType=BIGINT} LIMIT 1
	</select>

	<update id="updateMusicType" parameterType="com.busap.vcs.data.entity.MusicType">
		update music_type
		<set>
			<if test="id != null">
				id = #{id,jdbcType=BIGINT},
			</if>
			<if test="typeName != null and typeName != ''">
				type_name = #{typeName,jdbcType=VARCHAR},
			</if>
			<if test="creatorId != null">
				creator_id = #{creatorId,jdbcType=INTEGER},
			</if>
			<if test="dataFrom != null">
				data_from = #{dataFrom,jdbcType=VARCHAR},
			</if>
			<if test="modifyDate != null">
				modify_at = now(),
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>

</mapper>