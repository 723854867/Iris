<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.busap.vcs.data.mapper.IntegralDAO">
    
    <sql id="page">limit #{pageStart},#{pageSize}</sql>

    <select id="findUserIntegralDetailList"  resultType="com.busap.vcs.data.vo.IntegralDetailVO">
		select mes.* from
		(
			select a.id as id, a.create_time as createTime, a.modify_time as updateTime, a.type, a.user_id as userId, a.description, a.integral_num as integralNumber

			from integral a where a.user_id=#{userId} and a.status=1
			
			UNION
			
			select ic.id as id,ic.create_time as createTime ,ic.update_time as updateTime , ic.type, ic.user_id as userId, ic.description, (ic.consume_integral * -1) as integralNumber

			from integral_consume ic  where ic.user_id=#{userId}
		) mes
		
		ORDER BY mes.updateTime desc
		<include refid="page"/>
	</select>
	
	
	<select id="integralMultiTypeStatistics" resultType="com.busap.vcs.data.entity.IntegralStaDTO">
		select a.* from (select sum(integral.integral_num) as sum,integral.type as type ,date(integral.create_time) as createTime from integral integral where integral.type in(1,41,21,22,23,31,32,33,51) and date_sub(curdate(), INTERVAL 30 DAY) &lt;= date(integral.create_time) group by date(integral.create_time),integral.type) a order by a.createTime desc;   

	</select>

	<select id="selectIntegralMultiTypeStatistics" resultType="com.busap.vcs.data.model.IntegralStaDisplay">
		SELECT SUM(s.sum1) AS signSum,SUM(s.sum2) AS taskSum,s.date AS date FROM (
		SELECT
		(
		CASE
		WHEN i.type = 51 THEN
		i.integral_num
		ELSE '0'
		END
		) AS sum1,
		(
		CASE
		WHEN i.type <![CDATA[ <> ]]> 51 THEN
		i.integral_num
		ELSE '0'
		END
		) AS sum2,
		DATE(i.create_time) date
		FROM
		integral i
		WHERE
		i.type IN (1, 41, 21, 22, 23, 31, 32, 33,51)
		AND date_sub(curdate(), INTERVAL 30 DAY) <![CDATA[ <= ]]> DATE(i.create_time)) s
		GROUP BY
		DATE(s.date)
		ORDER BY s.date DESC
	</select>
</mapper>  
