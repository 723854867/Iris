<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.VideoDAO">

    <sql id="page">limit #{pageStart},#{pageSize}</sql>

    <sql id="videoFieldSql"> 
		select 
		v.id,                                                          
		v.create_at as createDate,                                                   
		v.creator_id as creatorId,                                             
		v.description,                                                 
		v.duration,                                                    
		v.evaluation_count as evaluationCount,                                       
		v.favorite_count as favoriteCount,                                       
		v.flow_stat as flowStat,                                      
		v.name,                                                       
		v.play_count as playCount,                                        
		v.play_key as playKey,                                            
		v.praise_count as praiseCount,                                         
		v.tag,
		v.play_count_today as playCountToday,                                             
		v.play_rate_today as  playRateToday,                                            
		v.latitude,
		v.longitude,
		v.gd_latitude as gdLatitude,
		v.gd_longitude as gdLongitude,                                                 
		v.coordinate_addr as coordinateAddr,                                   
		v.video_pic as videoPic,                                                    
		v.publish_time as publishTime,                                                
		v.is_logo as isLogo, 
		v.mp4Flg as mp4Flg,                                                 
		v.video_list_pic as videoListPic,
		v.day_hot_value as dayHotValue,
		v.rank_able as rankAble,
		v.weight,
		v.live_notice_id as liveNoticeId,
		v.type,
		v.live_notice_id
    </sql>
    
    <sql id="roomFieldSql"> 

		select 
		r.id,                                                          
		r.create_at as createDate,                                                   
		r.creator_id as creatorId,                                             
		r.room_pic as roomPic,                                                 
		r.title,                                                    
		r.finish_at as finishDate,                                       
		r.duration as duration,                                       
		r.max_access_number as maxAccessNumber,                                      
		r.rtmp_live_url as rtmpLiveUrl,
		r.hls_live_url as hlsLiveUrl,
		r.praise_number as praiseNumber                                                        
    </sql>
    
    <sql id="videoPraiseSql">
    	(SELECT count(p.id) from praise p where p.video_id=v.id and p.creator_id=#{uid})>0 as praise
    </sql>

    <sql id="videoFavoriteSql">
    	(SELECT count(f.id) from favorite f where f.video_id=v.id and f.creator_id=#{uid})>0 as favorite
	</sql>


    <select id="searchUserVideo" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"></include>
        ,r.username,
        r.phone
        from video v
        LEFT JOIN ruser r on v.creator_id=r.id
        where 1=1
        <if test="dataFrom != null">
            and v.data_from=#{dataFrom}
        </if>
        <if test="creatorName != null">
            and r.name like "%"#{creatorName}"%"
        </if>
        <if test="videoName != null">
            and v.description like "%"#{videoName}"%"
        </if>
        <if test="starttime != null">
            <![CDATA[
				and v.create_at>=#{starttime}
			]]>
        </if>
        <if test="endtime != null">
            <![CDATA[
				and v.create_at<=#{endtime}
			]]>
        </if>
        <if test="type != null">
            <![CDATA[
				and v.type = #{type}
			]]>
        </if>
        <if test="planStartTime != null">
            <![CDATA[
				and v.plan_publish_time>=#{planStartTime}
			]]>
        </if>
        <if test="planEndTime != null">
            <![CDATA[
				and v.plan_publish_time<=#{planEndTime}
			]]>
        </if>
        <choose>
            <when test="flowStat != null">
                <choose>
                    <when test="flowStat == 'checked'">
                        and (v.flow_stat='check_ok' or v.flow_stat='published')
                    </when>
                    <otherwise>
                        and v.flow_stat=#{flowStat}
                    </otherwise>
                </choose>
            </when>
            <otherwise>
                <![CDATA[
					and (v.flow_stat='published' or v.flow_stat='check_ok')
				]]>
            </otherwise>
        </choose>
        <if test="rankAble != null">
            and v.rank_able=#{rankAble}
        </if>
        <if test="introductionMark != null">
            and v.introduction_mark=#{introductionMark}
        </if>
        <if test="label != null">
            and v.id in(select video_id from label_video lv where lv.label_id = #{label})
        </if>
        <if test="activities != null">
            and v.id in(select videoid from activity_video av where activityid
            in (select a.id from activity a where a.id = #{activities}
            ))
        </if>
        <choose>
            <when test="noActivities != null">
                <if test="noActivities == 1">
                    and v.id NOT IN
                    (
                    select videoid from activity_video av where activityid
                    in
                    (
                    select a.id from activity a
                    )
                    )
                </if>
                <if test="noActivities == 2">
                    and v.id IN
                    (
                    select videoid from activity_video av where activityid
                    in
                    (
                    select a.id from activity a
                    )
                    )
                </if>
            </when>
        </choose>
        <if test="auditorId != null">
            and v.auditor_id=#{auditorId}
        </if>
        <if test="reason != null">
            and v.fail_reason like "%"#{reason}"%"
        </if>
        <if test="userId != null">
            and v.creator_id=#{userId}
        </if>
        <choose>
            <when test="user != null">
                <if test="user == 1">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.id = #{userKeyword}
                    </if>
                </if>
                <if test="user == 2">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.username LIKE CONCAT('%',#{userKeyword},'%')
                    </if>
                </if>
                <if test="user == 3">
                    <if test="userKeyword != null and userKeyword != ''">
                        AND r.name LIKE CONCAT('%',#{userKeyword},'%')
                    </if>
                </if>
                <if test="user == 4">
                    <if test="userKeyword != null and userKeyword != ''">
                       AND r.phone LIKE CONCAT('%',#{userKeyword},'%')
                    </if>
                </if>
            </when>
        </choose>
        ORDER BY v.create_at DESC
        <include refid="page"/>
    </select>

    <select id="searchNewVideo" resultType="com.busap.vcs.data.vo.VideoVO">
        SELECT t.*,r.`name` as creatorName FROM (SELECT v.id as id,v.publish_time as createDate,v.creator_id as creatorId,v.tag as tag,v.`name` as
        name,v.is_logo as isLogo,
        v.flow_stat as flowStat,v.play_key as playKey,v.data_from as dataFrom,v.description as description,
        v.url as url,v.video_pic as videoPic,v.evaluation_count as
        evaluationCount,v.praise_count as praiseCount
        from video v where 1=1
        <if test="videoName != null">
            and v.description like "%"#{videoName}"%"
        </if>
        <if test="starttime != null">
            <![CDATA[
				and v.publish_time>=#{starttime}
			]]>
        </if>
        <if test="endtime != null">
            <![CDATA[
				and v.publish_time<=#{endtime}
			]]>
        </if>
        <choose>
            <when test="flowStat != null">
                and v.flow_stat=#{flowStat}
            </when>
            <otherwise>
                <![CDATA[
					and v.flow_stat<>'delete' and v.flow_stat<>'check_fail' and v.flow_stat <>'planPublish'
				]]>
            </otherwise>
        </choose>
        ORDER BY v.publish_time DESC <include refid="page"/>) t
        LEFT JOIN ruser r on t.creatorId=r.id
        <if test="creatorName != null">
            WHERE r.name like "%"#{creatorName}"%"
        </if>
    </select>

    <select id="searchHotVideo" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"></include>
        ,r.username,
        r.phone
        from video v
        LEFT JOIN ruser r ON r.id = v.creator_id
        where v.play_rate_today>0 and (v.flow_stat='published' or v.flow_stat='check_ok')
        <if test="dataFrom != null">
            and v.data_from=#{dataFrom}
        </if>
        <if test="creatorName != null">
            and r.name like "%"#{creatorName}"%"
        </if>
        <if test="videoName != null">
            and v.description like "%"#{videoName}"%"
        </if>
        <if test="starttime != null">
            <![CDATA[
				and v.create_at>=#{starttime}
			]]>
        </if>
        <if test="endtime != null">
            <![CDATA[
				and v.create_at<=#{endtime}
			]]>
        </if>

        <if test="rankAble != null">
            and v.rank_able=#{rankAble}
        </if>
        <if test="label != null">
            and v.id in(select video_id from label_video lv where lv.label_id = #{label})
        </if>
        <if test="activities != null">
            and v.id in(select videoid from activity_video av where activityid
            in (select a.id from activity a where a.id = #{activities}
            ))
        </if>
        <choose>
            <when test="user != null">
                <if test="user == 1">
                    AND r.id = #{userKeyword}
                </if>
                <if test="user == 2">
                    AND r.username LIKE CONCAT('%',#{userKeyword},'%')
                </if>
                <if test="user == 3">
                    AND r.name LIKE CONCAT('%',#{userKeyword},'%')
                </if>
                <if test="user == 4">
                    AND r.phone LIKE CONCAT('%',#{userKeyword},'%')
                </if>
            </when>
        </choose>
        ORDER BY v.play_rate_today DESC

        <include refid="page"/>
    </select>

    <select id="searchHotVideoCount" resultType="Integer">
        select count(v.id) from video v LEFT JOIN ruser r on v.creator_id=r.id
        where v.play_rate_today>0 and (v.flow_stat='published' or v.flow_stat='check_ok')
        <if test="dataFrom != null">
            <![CDATA[
				and v.data_from>=#{dataFrom}
			]]>
        </if>
        <if test="creatorName != null">
            and r.name like "%"#{creatorName}"%"
        </if>
        <if test="videoName != null">
            and v.name like "%"#{videoName}"%"
        </if>
        <if test="starttime != null">
            <![CDATA[
				and v.create_at>=#{starttime}
			]]>
        </if>
        <if test="endtime != null">
            <![CDATA[
				and v.create_at<=#{endtime}
			]]>
        </if>

        <if test="rankAble != null">
            and v.rank_able=#{rankAble}
        </if>
        <if test="creatorName != null">
            and r.name like #{creatorName}
        </if>
        <if test="label != null">
            and v.id in(select video_id from label_video lv where lv.label_id = #{label})
        </if>
        <if test="activities != null">
            and v.id in(select videoid from activity_video av where activityid
            in (select a.id from activity a where a.id = #{activities}
            ))
        </if>
        <choose>
            <when test="user != null">
                <if test="user == 1">
                    AND r.id = #{userKeyword}
                </if>
                <if test="user == 2">
                    AND r.username LIKE CONCAT('%',#{userKeyword},'%')
                </if>
                <if test="user == 3">
                    AND r.name LIKE CONCAT('%',#{userKeyword},'%')
                </if>
                <if test="user == 4">
                    AND r.phone LIKE CONCAT('%',#{userKeyword},'%')
                </if>
            </when>
        </choose>
    </select>


    <select id="searchUserVideoCount" resultType="Integer">
        select count(v.id) from video v LEFT JOIN ruser r on v.creator_id=r.id
        where 1=1
        <if test="dataFrom != null">
            <![CDATA[
				and v.data_from>=#{dataFrom}
			]]>
        </if>
        <if test="creatorName != null">
            and r.name like "%"#{creatorName}"%"
        </if>
        <if test="videoName != null">
            and v.description like "%"#{videoName}"%"
        </if>
        <if test="starttime != null">
            <![CDATA[
				and v.create_at>=#{starttime}
			]]>
        </if>
        <if test="endtime != null">
            <![CDATA[
				and v.create_at<=#{endtime}
			]]>
        </if>
        <if test="planStartTime != null">
            <![CDATA[
				and v.plan_publish_time>=#{planStartTime}
			]]>
        </if>
        <if test="planEndTime != null">
            <![CDATA[
				and v.plan_publish_time<=#{planEndTime}
			]]>
        </if>
        <choose>
            <when test="flowStat != null">
                <choose>
                    <when test="flowStat == 'checked'">
                        and (v.flow_stat='check_ok' or v.flow_stat='published')
                    </when>
                    <otherwise>
                        and v.flow_stat=#{flowStat}
                    </otherwise>
                </choose>
            </when>
            <otherwise>
                <![CDATA[
					and (v.flow_stat='published' or v.flow_stat='check_ok')
				]]>
            </otherwise>
        </choose>
        <if test="rankAble != null">
            and v.rank_able=#{rankAble}
        </if>
        <if test="introductionMark != null">
            and v.introduction_mark=#{introductionMark}
        </if>
        <if test="creatorName != null">
            and r.name like #{creatorName}
        </if>
        <if test="label != null">
            and v.id in(select video_id from label_video lv where lv.label_id = #{label})
        </if>
        <if test="activities != null">
            and v.id in(select videoid from activity_video av where activityid
            in (select a.id from activity a where a.id = #{activities}
            ))
        </if>
        <choose>
            <when test="noActivities != null">
                <if test="noActivities == 1">
                    and v.id NOT IN
                    (
                    select videoid from activity_video av where activityid
                    in
                    (
                    select a.id from activity a
                    )
                    )
                </if>
                <if test="noActivities == 2">
                    and v.id IN
                    (
                    select videoid from activity_video av where activityid
                    in
                    (
                    select a.id from activity a
                    )
                    )
                </if>
            </when>
        </choose>
        <if test="auditorId != null">
            and v.auditor_id=#{auditorId}
        </if>
        <if test="reason != null">
            and v.fail_reason like "%"#{reason}"%"
        </if>
        <if test="userId != null">
            and v.creator_id=#{userId}
        </if>
        <choose>
            <when test="user != null">
                <if test="user == 1">
                    AND r.id = #{userKeyword}
                </if>
                <if test="user == 2">
                    AND r.username LIKE CONCAT('%',#{userKeyword},'%')
                </if>
                <if test="user == 3">
                    AND r.name LIKE CONCAT('%',#{userKeyword},'%')
                </if>
                <if test="user == 4">
                    AND r.phone LIKE CONCAT('%',#{userKeyword},'%')
                </if>
            </when>
        </choose>
        <if test="type != null">
            <![CDATA[
				and v.type = #{type}
			]]>
        </if>
    </select>

    <select id="searchNewVideoCount" resultType="Integer">
        SELECT t.vCount FROM (SELECT COUNT(*) AS vCount,v.creator_id AS creatorId
        from video v where 1=1
        <if test="videoName != null">
            and v.description like "%"#{videoName}"%"
        </if>
        <if test="starttime != null">
            <![CDATA[
				and v.publish_time>=#{starttime}
			]]>
        </if>
        <if test="endtime != null">
            <![CDATA[
				and v.publish_time<=#{endtime}
			]]>
        </if>
        <choose>
            <when test="flowStat != null">
                and v.flow_stat=#{flowStat}
            </when>
            <otherwise>
                <![CDATA[
					and v.flow_stat<>'delete' and v.flow_stat<>'check_fail' and v.flow_stat <>'planPublish'
				]]>
            </otherwise>
        </choose>
        ) t
        LEFT JOIN ruser r on t.creatorId=r.id
        <if test="creatorName != null">
            WHERE r.name like "%"#{creatorName}"%"
        </if>
    </select>

    <select id="getFavoriteList" resultType="com.busap.vcs.data.entity.Video">
        select v.id,
        f.create_at as publishTime,
        v.creator_id as creatorId,
        v.description,
        v.duration,
        v.evaluation_count as evaluationCount,
        v.favorite_count as favoriteCount,
        v.name,
        v.play_count as playCount,
        v.play_key as playKey,
        v.praise_count as praiseCount,
        v.tag,
        v.play_rate_today as playRateToday,
        v.latitude,
        v.longitude,
        v.gd_latitude as gdLatitude,
        v.gd_longitude as gdLongitude,
        v.coordinate_addr as coordinateAddr,
        v.video_pic as videoPic,
        v.video_list_pic as videoListPic,
        v.is_logo as isLogo,
        TRUE as favorite ,(SELECT COUNT(p.id) FROM praise p where p.creator_id=#{uid} and p.video_id=v.id)>0 as praise
        from video v, favorite f where v.id=f.video_id
        and v.flow_stat!='delete' and f.creator_id=#{uid}
        <if test="date!=null">
            <![CDATA[and f.create_at<#{date}]]>
        </if>
        order by f.create_at desc limit #{count}
    </select>

    <select id="getVideoPraiseUserList" resultType="java.util.Map">
        SELECT u.id,u.`name`,u.pic,u.signature,u.vstat as vipStat ,p.id as praiseId,p.create_at as
        praiseDate,u.fans_count as fansCount,u.attention_count as attentionCount
        <if test="uid!=null">
            ,IF((SELECT count(*) from attention a WHERE a.attention_id=u.id and a.creator_id=#{uid})>0,1 + (SELECT count(*) from attention a WHERE a.creator_id=u.id and a.attention_id=#{uid}),0) as attention
        </if>
        <if test="uid==null">
            , false as attention
        </if>
        from ruser u ,praise p
        WHERE u.id=p.creator_id
        and p.video_id=#{vid}
        <if test="pid!=null and pid!=0">
            <![CDATA[and p.id<#{pid}]]>
        </if>
        ORDER BY p.id DESC limit #{count}
    </select>


    <select id="findNewVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        from video v where
        (v.flow_stat='published' or (creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        ORDER BY v.publish_time DESC limit #{count}
    </select>


    <select id="findActVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>

        from video v ,activity_video a where a.activityid=#{actId} and v.id=a.videoid
        and (v.flow_stat='published' or v.flow_stat='check_ok') 
        ORDER BY a.order_num DESC,a.id DESC
        <include refid="page"/>
    </select>

    <select id="findRelatedVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
            ,(SELECT count(a.attention_id) from attention a WHERE a.attention_id=v.creator_id and a.creator_id=#{uid})>0
            as attentionAuthor
        </if>

        from video v ,activity_video a where v.id=a.videoid
        and (v.flow_stat='published' or v.flow_stat='check_ok')
        and a.activityid=#{activityId} and v.id != #{videoId}

        <if test="orderByFiled=='praise_count'">
            ORDER BY v.praise_count desc
        </if>
        <if test="orderByFiled=='play_count'">
            ORDER BY v.play_count desc
        </if>
        <include refid="page"/>
    </select>

    <select id="findActVideosByTimestamp" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>

        from video v ,activity_video a where a.activityid=#{actId} and v.id=a.videoid
        and (v.flow_stat='published' or v.flow_stat='check_ok') 
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        ORDER BY v.publish_time DESC limit #{count}
    </select>
    
    <select id="findActVideosAfterAssignedTime" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>

        from video v ,activity_video a where a.activityid=#{actId} and v.id=a.videoid
        and (v.flow_stat='published' or v.flow_stat='check_ok') 
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time>#{timestamp}]]>
        </if>
        limit #{count}
    </select>


    <select id="findUserVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        from video v where
        v.creator_id=#{userid} 
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
         <if test="uid==userid">
            and  (v.flow_stat='published' or v.flow_stat='uncheck' or v.flow_stat='check_ok' or v.flow_stat='check_fail')
        </if>
        <if test="uid!=userid">
            and  (v.flow_stat='published' or v.flow_stat='check_ok')
        </if>
        
        <if test="type!=null and type!=''">
        	<if test="type==34">
            	<![CDATA[and v.type in (3,4)]]>
            </if>
            <if test="type ==134 ">
            	<![CDATA[and v.type  in (1,3,4) ]]>
            </if>
            
            <if test="type !=34 and type !=134  ">
            	<![CDATA[and v.type =#{type} ]]>
            </if>
            
        </if>
        
        ORDER BY v.publish_time DESC limit #{count}
    </select>

    <select id="findUserVideosAndForward" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,0 as isForward
        ,'' as forwardEvaluation
        ,0 as forwardUserId
        ,v.publish_time as forwardTime
        from video v where
        
         v.creator_id=#{userid} 
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        <if test="uid==userid">
            and (v.flow_stat='published' or v.flow_stat='uncheck' or v.flow_stat='check_ok' or v.flow_stat='check_fail')
        </if>
        <if test="uid!=userid">
            and (v.flow_stat='published' or v.flow_stat='check_ok')
        </if>
        
        <if test="type!=null and type!=''">
        	<if test="type==34">
            	<![CDATA[and v.type in (3,4)]]>
            </if>
            <if test="type ==134 ">
            	<![CDATA[and v.type  in (1,3,4) ]]>
            </if>
            
            <if test="type !=34 and type !=134  ">
            	<![CDATA[and v.type =#{type} ]]>
            </if>
            
        </if>

        union all

        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,1 as isForward
        ,f.evaluation as forwardEvaluation
        ,f.creator_id as forwardUserId
        ,f.create_at as forwardTime
        from video v ,forward f where  f.creator_id=#{userid} and v.id=f.video_id  
        
         <if test="timestamp!=null">
            <![CDATA[and f.create_at<#{timestamp}]]>
        </if>
        <if test="uid==userid">
            and (v.flow_stat='published' or v.flow_stat='uncheck' or v.flow_stat='check_ok' or v.flow_stat='check_fail')
        </if>
        <if test="uid!=userid">
             and (v.flow_stat='published' or v.flow_stat='check_ok')
        </if>
        
        <if test="type!=null and type!=''">
        	<if test="type==34">
            	<![CDATA[and v.type in (3,4)]]>
            </if>
            <if test="type ==134 ">
            	<![CDATA[and v.type  in (1,3,4) ]]>
            </if>
            
            <if test="type !=34 and type !=134  ">
            	<![CDATA[and v.type =#{type} ]]>
            </if>
            
        </if>
       


        ORDER BY forwardTime DESC limit #{count}
    </select>

    <select id="findAttentionNewVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,
        1 as attentionAuthor
        from video v where
        (v.flow_stat='published' or (creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        and v.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>

        ORDER BY v.publish_time DESC limit #{count}
    </select>

    <select id="findAttentionNewVideosAndForward" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,1 as attentionAuthor
        ,0 as isForward
        ,'' as forwardEvaluation
        ,0 as forwardUserId
        ,v.publish_time as forwardTime
        from video v where
        
        v.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        and
        (v.flow_stat='published' or (v.creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and v.creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        

        union all

        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,1 as attentionAuthor
        ,1 as isForward
        ,f.evaluation as forwardEvaluation
        ,f.creator_id as forwardUserId
        ,f.create_at as forwardTime

        from video v,forward f where f.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        and v.id=f.video_id

        and (v.flow_stat='published' or (v.creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and v.creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and f.create_at<#{timestamp}]]>
        </if>

        ORDER BY forwardTime DESC limit #{count}
    </select>
    
    <select id="getAttentionInfoList" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,1 as attentionAuthor
        ,0 as isForward
        ,'' as forwardEvaluation
        ,0 as forwardUserId
        ,v.publish_time as forwardTime
        from video v where
        
        v.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        and
        (v.flow_stat='published' or (v.creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and v.creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        
        <if test="type!=null and type!=''">
        	<if test="type==34">
            	<![CDATA[and v.type in (3,4)]]>
            </if>
            <if test="type ==134 ">
            	<![CDATA[and v.type  in (1,3,4) ]]>
            </if>
            
            <if test="type !=34 and type !=134  ">
            	<![CDATA[and v.type =#{type} ]]>
            </if>
            
        </if>
        

        union all

        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        ,1 as attentionAuthor
        ,1 as isForward
        ,f.evaluation as forwardEvaluation
        ,f.creator_id as forwardUserId
        ,f.create_at as forwardTime

        from video v,forward f where f.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        and v.id=f.video_id

        and (v.flow_stat='published' or (v.creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and v.creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and f.create_at<#{timestamp}]]>
        </if>
        
        <if test="type!=null and type!=''">
        	<if test="type==34">
            	<![CDATA[and v.type in (3,4)]]>
            </if>
            
            <if test="type ==134 ">
            	<![CDATA[and v.type  in (1,3,4) ]]>
            </if>
            
            <if test="type !=34 and type !=134  ">
            	<![CDATA[and v.type =#{type} ]]>
            </if>
        </if>

        ORDER BY forwardTime DESC limit #{count}
    </select>

    <select id="getAttentionLiveInfoList" resultType="com.busap.vcs.data.entity.Room">
        
        <include refid="roomFieldSql"/>
        from room r where
        
        r.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
         
        and r.status=1 

        ORDER BY create_at DESC limit #{start},#{count}
    </select>

    <select id="findOtherAttentionNewVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
            ,
            (select count(*) from attention a where a.attention_id=v.creator_id and a.creator_id=#{uid}) as
            attentionAuthor
        </if>
        from video v where
        (v.flow_stat='published' or v.flow_stat='check_ok')
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        and v.creator_id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        ORDER BY v.publish_time DESC limit #{count}
    </select>

    <select id="isCheckedOk" resultType="java.lang.Boolean">
    	select count(v.id)>0 from video v where v.flow_stat='check_ok' and v.id=#{vid}
    </select>

    <select id="getVideoStat" resultType="java.lang.String">
    	select v.flow_stat from video v where v.id=#{vid}
    </select>

    <select id="getAllIndiceOfVideo" resultType="java.util.Map"> 
	    select 
	    AVG(a.praise_count) as avgPraise,
	    AVG(a.evaluation_count) as avgEvaluation,
	    AVG(a.play_count) as avgPlay,
	    AVG(a.hourAfterPublish) as avgHourAfterPublish
	    
	     from 
	     (select praise_count,
	     evaluation_count,
	     play_count,
	     case when HOUR(TIMEDIFF(create_at,CURRENT_TIMESTAMP()))/24 > 1 then 1 
	          else HOUR(TIMEDIFF(create_at,CURRENT_TIMESTAMP()))/24 
	          end as hourAfterPublish
	     from video order by id desc limit 5000) a
    </select>

    <select id="findVideoByHotPoint" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        , (praise_count*#{avgPraise}+
        evaluation_count*#{avgEvaluation}+
        play_count*#{avgPlay}+
        (1-case when HOUR(TIMEDIFF(create_at,CURRENT_TIMESTAMP())) > 24 then 1 ELSE
        (HOUR(TIMEDIFF(create_at,CURRENT_TIMESTAMP()))*60+MINUTE(TIMEDIFF(create_at,CURRENT_TIMESTAMP())))/1440
        end)*#{avgHourAfterPublish}
        )
        as hotPoint
        from video v where
        (v.flow_stat='published' or (creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and creator_id != #{uid}))
        <if test="activityId!=null and activityId!=''">
            and v.id in (select videoid from activity_video where activityid=#{activityId})
        </if>
        ORDER BY hotPoint DESC,create_at DESC limit #{count}
    </select>

    <select id="findRefVideos" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <if test="uid!=null and uid!=''">
            ,
            <include refid="videoPraiseSql"/>
            ,
            <include refid="videoFavoriteSql"/>
        </if>
        from video v where
        (v.flow_stat='published' or (creator_id=#{uid} and (v.flow_stat='uncheck' or v.flow_stat='check_ok')) or
        (v.flow_stat='check_ok' and creator_id != #{uid}))
        <if test="timestamp!=null">
            <![CDATA[and v.publish_time<#{timestamp}]]>
        </if>
        and v.id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        ORDER BY v.publish_time DESC limit #{count}
    </select>
    <!-- 
    <select id="execDayHotVideoProc" statementType="CALLABLE" >
    	 <![CDATA[
	        {call proc_videoDayHot(
	            #{playCountRate,mode=IN,jdbcType=DOUBLE},
	            #{evaluationCountRate,mode=IN,jdbcType=DOUBLE},
	            #{praiseCountRate,mode=IN,jdbcType=DOUBLE}
	        )}
	    ]]>
    </select>
     -->
    <update id="execDayHotVideoProc">
     	UPDATE video set day_hot_value=#{hotValue} where id=#{vid}
     </update>

    <select id="findDayHotTop50" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <![CDATA[
		     from video v,ruser r
				where TIMESTAMPDIFF(DAY,v.create_at,now())<7 and (v.flow_stat='published' or v.flow_stat='check_ok') 
					and v.creator_id=r.id and r.rank_able<>1	   
		     	ORDER BY v.day_hot_value DESC limit #{count}
	     ]]>
    </select>

    <select id="findUserVideoByDayHotValue" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <![CDATA[
	     	from video v where TIMESTAMPDIFF(DAY,v.create_at,now())<7 and(v.flow_stat='published' or v.flow_stat='check_ok') and v.creator_id=#{uid}
	     	ORDER BY v.day_hot_value DESC limit 1
	     ]]>
    </select>

    <select id="findNoneDurationVideos" resultType="com.busap.vcs.data.entity.Video">  
	     select
	     v.id,
	     v.play_key as playKey
	  
	     from video v where v.duration is null limit #{count}
    </select>

    <select id="dayVideoPlayCount" resultType="Integer">
     	<![CDATA[

    		select count(ph.id) as playCount from play_history ph where TIMESTAMPDIFF(HOUR,ph.create_at,now())<24 and ph.video_id=#{vid};

        ]]>
    </select>

    <select id="dayVideoEvaCount" resultType="Integer">
     	<![CDATA[

    		select count(e.id) as evalCount from evaluation e where TIMESTAMPDIFF(HOUR,e.create_at,now())<24 and e.video_id=#{vid};

        ]]>
    </select>

    <select id="dayVideoPraiseCount" resultType="Integer">
     	<![CDATA[

    		select count(p.id) as praiseCount from praise p where TIMESTAMPDIFF(HOUR,p.create_at,now())<24 and p.video_id=#{vid};

        ]]>
    </select>

    <select id="findMaxPlayRate" resultType="java.math.BigDecimal">
    	select max(play_rate_today) from video
    </select>

    <select id="findVideoUperPlayRate" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <![CDATA[
	    	from video v
	    	where v.play_rate_today>#{playRate} and (v.flow_stat='published' or v.flow_stat='check_ok')
	    	order by v.play_rate_today asc
	    	limit 1
    	]]>
    </select>

    <select id="findVideoLowerPlayRate" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        <![CDATA[
	    	from video v
	    	where v.play_rate_today<#{playRate} and (v.flow_stat='published' or v.flow_stat='check_ok')
	    	order by v.play_rate_today desc
	    	limit 1
    	]]>
    </select>

    <update id="removeHotVideos">
        update video v set v.play_rate_today=0 where v.id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="selectVideosByCreatorId" parameterType="java.lang.Long" resultType="com.busap.vcs.data.entity.Video">
		SELECT id FROM video WHERE
		creator_id = #{creatorId}
	</select>

    <select id="selectHotVideoRankingList" resultType="com.busap.vcs.data.entity.Video" parameterType="java.util.Map">
        <include refid="videoFieldSql"/>
		FROM video v,ruser r
		WHERE
        <if test="type != null and type != ''">
            <choose>
                <when test="type == 'day'">
                    TIMESTAMPDIFF(HOUR,v.create_at,now()) <![CDATA[ < ]]> #{typeCount} AND
                </when>
                <when test="type == 'week'">
                    TIMESTAMPDIFF(DAY,v.create_at,now()) <![CDATA[ < ]]> 7 AND
                </when>
                <when test="type == 'month'">
                    TIMESTAMPDIFF(MONTH,v.create_at,now()) <![CDATA[ < ]]> 1 AND
                </when>
                <when test="type == 'year'">
                    TIMESTAMPDIFF(YEAR,v.create_at,now()) <![CDATA[ < ]]> 1 AND
                </when>
            </choose>
        </if>
        (v.flow_stat='published' OR v.flow_stat='check_ok')
        AND v.creator_id=r.id AND r.rank_able <![CDATA[ <> ]]> 1
        AND v.rank_able <![CDATA[ <> ]]> 1
        ORDER BY v.day_hot_value DESC,v.create_at DESC limit #{count}
    </select>

    <select id="selectUserHotVideoRank" resultType="com.busap.vcs.data.entity.Video" parameterType="java.util.Map">
        <include refid="videoFieldSql"/>
	     	FROM video v WHERE
            <if test="type != null and type != ''">
                <choose>
                    <when test="type == 'day'">
                        TIMESTAMPDIFF(HOUR,v.create_at,now()) <![CDATA[ < ]]> #{typeCount} AND
                    </when>
                    <when test="type == 'week'">
                        TIMESTAMPDIFF(DAY,v.create_at,now()) <![CDATA[ < ]]> 7 AND
                    </when>
                    <when test="type == 'month'">
                        TIMESTAMPDIFF(MONTH,v.create_at,now()) <![CDATA[ < ]]> 1 AND
                    </when>
                    <when test="type == 'year'">
                        TIMESTAMPDIFF(YEAR,v.create_at,now()) <![CDATA[ < ]]> 1 AND
                    </when>
                </choose>
            </if>
	     	(v.flow_stat='published' or v.flow_stat='check_ok') AND v.creator_id=#{uid}
            AND v.rank_able <![CDATA[ <> ]]> 1
	     	ORDER BY v.day_hot_value DESC limit 1
    </select>

    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultType="com.busap.vcs.data.entity.Video">
        SELECT id,flow_stat as flowStat,weight FROM video WHERE id = #{id}
    </select>

<!--    <select id="selectWopaiUserByVideo" parameterType="map" resultType="com.busap.vcs.data.model.ExportWopaiNormalUser">
        SELECT
        r.id,
		r.name,
		r.video_count AS videoCount,
		r.fans_count AS fansCount,
        IFNULL(a.realFansCount,0) AS realFansCount,
		r.sign_sum AS signSum,
		r.`24hour_popularity` AS twentyFourPopularity,
		r.week_popularity AS weekPopularity,
		r.month_popularity AS monthPopularity,
		r.create_at AS createDate,
        CASE WHEN(r.sex = 1) THEN "男"
        WHEN(r.sex = 0) THEN "女"
        ELSE "未知" END AS sex,
        (year(now())-year(r.birthday)-1) + ( DATE_FORMAT(r.birthday, '%m%d') <![CDATA[ <= ]]> DATE_FORMAT(NOW(), '%m%d') ) AS age,
        r.addr AS address
        <choose>
            <when test="startDate !=null and startDate != '' and endDate !=null and endDate != ''">
                ,CONCAT(#{startDate},"至",#{endDate}) AS uploadVideoDate
            </when>
            <otherwise>
                <if test="startDate !=null and startDate != ''">
                    ,CONCAT(#{startDate},"之后","") AS uploadVideoDate
                </if>
                <if test="endDate !=null and endDate != ''">
                    ,CONCAT(#{endDate},"之前","") AS uploadVideoDate
                </if>
            </otherwise>
        </choose>
        FROM
        (
        SELECT
        v.creator_id,
        v.create_at
        FROM
        video v WHERE (v.flow_stat='published' or v.flow_stat='check_ok') GROUP BY creator_id ORDER BY create_at DESC
        ) t
        LEFT JOIN ruser r ON r.id = t.creator_id
        LEFT JOIN (
		select attention_id AS attentionId,count(*) AS realFansCount from attention WHERE majia_attention = 0 GROUP BY attention_id
		) a ON a.attentionId = r.id
		WHERE r.type = "normal"
        <if test="stat !=  null">
            AND stat = #{stat,jdbcType=INTEGER}
        </if>
        <if test="vstat !=  null">
            AND r.vstat = #{vstat,jdbcType=INTEGER}
        </if>
        <if test="sex !=  null">
            AND sex = #{sex,jdbcType=INTEGER}
        </if>
        <if test="thirdFrom !=  null and thirdFrom != ''">
            AND r.third_from = #{thirdFrom,jdbcType=VARCHAR}
        </if>
        <if test="rankAble !=  null">
            AND rank_able = #{rankAble,jdbcType=INTEGER}
        </if>
        <if test="addr != null and addr !=''">
            AND addr LIKE CONCAT('%',#{addr,jdbcType=VARCHAR},'%')
        </if>
        <if test="startCount !=  null">
            AND video_count <![CDATA[ >= ]]> #{startCount,jdbcType=INTEGER}
        </if>
        <if test="endCount !=  null">
            AND video_count <![CDATA[ <= ]]> #{endCount,jdbcType=INTEGER}
        </if>
        <if test="startTime !=null and startTime != ''">
            <![CDATA[ AND DATE_FORMAT(r.create_at, '%Y-%m-%d')  >= #{startTime,jdbcType=TIMESTAMP} ]]>
        </if>
        <if test="endTime !=null and endTime != ''">
            <![CDATA[ AND DATE_FORMAT(r.create_at, '%Y-%m-%d')  <= #{endTime,jdbcType=TIMESTAMP} ]]>
        </if>
        &lt;!&ndash;<choose>
            <when test="exportUserKey != null and exportUserKey != ''">
                <if test="exportUserKey == 1">
                    <if test="exportUserKeyword != null and exportUserKeyword != ''">
                        AND id = #{exportUserKeyword}
                    </if>
                </if>
                <if test="exportUserKey == 2">
                    <if test="exportUserKeyword != null and exportUserKeyword != ''">
                        AND username LIKE CONCAT('%',#{exportUserKeyword},'%')
                    </if>
                </if>
                <if test="exportUserKey == 3">
                    <if test="exportUserKeyword != null and exportUserKeyword != ''">
                        AND name LIKE CONCAT('%',#{exportUserKeyword},'%')
                    </if>
                </if>
                <if test="exportUserKey == 4">
                    <if test="exportUserKeyword != null and exportUserKeyword != ''">
                        AND phone LIKE CONCAT('%',#{exportUserKeyword},'%')
                    </if>
                </if>
            </when>
        </choose>&ndash;&gt;
        <if test="regPlatform != null and regPlatform !=''">
            AND reg_platform LIKE CONCAT('%',#{regPlatform,jdbcType=VARCHAR},'%')
        </if>
        <if test="regPlatformChannel != null and regPlatformChannel !=''">
            AND reg_platform = #{regPlatformChannel,jdbcType=VARCHAR}
        </if>
        <if test="allowPublish !=  null">
            AND allow_publish = #{allowPublish,jdbcType=INTEGER}
        </if>
        <if test="isAnchor !=  null">
            AND is_anchor = #{isAnchor,jdbcType=INTEGER}
        </if>
        <if test="organizationId !=  null">
            AND organization_id = #{organizationId,jdbcType=BIGINT}
        </if>
        <if test="startDate !=null and startDate != ''">
            <![CDATA[ AND DATE_FORMAT(t.create_at, '%Y-%m-%d')  >= #{startDate,jdbcType=TIMESTAMP} ]]>
        </if>
        <if test="endDate !=null and endDate != ''">
            <![CDATA[ AND DATE_FORMAT(t.create_at, '%Y-%m-%d')  <= #{endDate,jdbcType=TIMESTAMP} ]]>
        </if>
        ORDER BY r.create_at DESC
		<if test="exportCount != null and exportCount>0">
            LIMIT #{exportCount}
        </if>
    </select>-->

    <update id="updateSort" parameterType="java.util.Map">
        UPDATE video
        <set>
            weight= #{weight}
        </set>
        WHERE id = #{id}
    </update>

    <select id="selectVideoByWeight" parameterType="java.util.Map" resultType="com.busap.vcs.data.entity.Video">
        SELECT
        id,
        weight
        FROM
        video
        <if test="ASC != '' and ASC != null">
            WHERE weight <![CDATA[ > ]]> #{weight}
            AND <![CDATA[ flow_stat<>'delete' ]]>
            ORDER BY weight ASC
        </if>
        <if test="DESC != '' and DESC != null">
            WHERE weight <![CDATA[ < ]]> #{weight}
            AND <![CDATA[ flow_stat<>'delete' ]]>
            ORDER BY weight DESC
        </if>
        <if test="MAX != '' and MAX != null">
            WHERE <![CDATA[ flow_stat<>'delete' ]]>
            ORDER BY weight DESC
        </if>
        LIMIT 1
    </select>
    
    <select id="getLiveBackCount" resultType="Integer">
    	<![CDATA[
    		select count(*) from video v where v.type=2 and v.flow_stat<>'delete'
    	]]>
    </select>
    
    <select id="findLiveBackList" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        	from video v 
        	<if test="liveActivityId != null">
        		left join room r on r.id=v.live_notice_id
        	</if>
        	where v.type=2 
        	<if test="liveActivityId != null">
        		and r.live_activity_id =#{liveActivityId}
        	</if>
        	<if test="false">
        		and v.create_at > #{timeLimit}
        	</if>
        <![CDATA[
        	and v.flow_stat<>'delete'

        	and v.version_num >= '3.1.3'

        	ORDER BY v.playback_weight desc LIMIT ${start},${end}
        ]]>
    </select>

    <select id="findNewLiveBackList" resultType="com.busap.vcs.data.entity.Video">
        <include refid="videoFieldSql"/>
        	from video v
        	<if test="liveActivityId != null">
        		left join room r on r.id=v.live_notice_id
        	</if>
        	where v.type=2
        	<if test="liveActivityId != null">
        		and r.live_activity_id =#{liveActivityId}
        	</if>
        	<if test="false">
        		and v.create_at > #{timeLimit}
        	</if>
        <![CDATA[
        	and v.flow_stat<>'delete'

        	and v.version_num >= '3.1.3'

        	ORDER BY v.create_at desc LIMIT ${start},${end}
        ]]>
    </select>
    
    <select id="searchHotVideoV3" resultType="Map">
        <include refid="videoFieldSql"></include>
        
        from video v
        where (v.flow_stat='published' or v.flow_stat='check_ok') and v.type != 2
        
        ORDER BY v.weight DESC,v.create_at desc

        <include refid="page"/>
    </select>

    <select id="select" resultType="com.busap.vcs.data.entity.Video" parameterType="map">
        <include refid="videoFieldSql"/>
        FROM video v
        <where>
            <if test="type != null">
                v.type = ${type} AND
            </if>
            <![CDATA[v.flow_stat<>'delete']]>
        </where>
        ORDER BY v.create_at DESC
    </select>

    <select id="selectVideoByLiveNoticeId" resultType="com.busap.vcs.data.entity.Video" parameterType="java.lang.Long">
        SELECT id FROM video WHERE live_notice_id = #{liveNoticeId,jdbcType=BIGINT}
    </select>

    <select id="selectMissPlaybackByPersistentId" resultType="com.busap.vcs.data.entity.MissingPlaybackInfo" parameterType="java.lang.String">
        SELECT
        persistent_id AS persistentId,
        playkey,
        room_id AS roomId,
        stream_id AS streamId
        FROM missing_playback_info
        WHERE
        persistent_id = #{persistentId,jdbcType=VARCHAR}
    </select>

    <update id="updateMissPlaybackByPersistentId" parameterType="com.busap.vcs.data.entity.MissingPlaybackInfo">
        UPDATE missing_playback_info
        <set>
            <if test="persistentId != null and persistentId != ''">
                persistent_id = #{persistentId,jdbcType=VARCHAR},
            </if>
            <if test="roomId != null">
                room_id = #{roomId,jdbcType=BIGINT},
            </if>
            <if test="playkey != null and playkey != ''">
                playkey = #{playkey,jdbcType=VARCHAR},
            </if>
            <if test="streamId != null and streamId != ''">
                stream_id = #{streamId,jdbcType=VARCHAR},
            </if>
        </set>
        WHERE persistent_id = #{persistentId,jdbcType=VARCHAR}
    </update>

    <insert id="insertMissPlayback" parameterType="com.busap.vcs.data.entity.MissingPlaybackInfo">
        INSERT INTO missing_playback_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            create_at,
            <if test="persistentId != null and persistentId != ''">
                persistent_id,
            </if>
            <if test="roomId != null">
                room_id,
            </if>
            <if test="playkey != null and playkey != ''">
                playkey,
            </if>
            <if test="streamId != null and streamId != ''">
                stream_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            now(),
            <if test="persistentId != null and persistentId != ''">
                #{persistentId,jdbcType=VARCHAR},
            </if>
            <if test="roomId != null">
                #{roomId,jdbcType=BIGINT},
            </if>
            <if test="playkey != null and playkey != ''">
                #{playkey,jdbcType=VARCHAR},
            </if>
            <if test="streamId != null and streamId != ''">
                #{streamId,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <select id="selectMPByStreamId" resultType="com.busap.vcs.data.entity.MissingPlaybackInfo" parameterType="java.lang.String">
        SELECT
        persistent_id AS persistentId,
        playkey,
        room_id AS roomId,
        stream_id AS streamId
        FROM missing_playback_info
        WHERE
        stream_id = #{streamId,jdbcType=VARCHAR}
    </select>

</mapper>
