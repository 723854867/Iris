<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.busap.vcs.data.mapper.RoomDao">

    <select id="selectLiveDetailRecord" parameterType="map" resultType="com.busap.vcs.data.model.LiveDetailDisplay">
        SELECT
        r.id,
        ru.id AS userId,
        ru.name,
        ru.band_phone AS bandPhone,
        ru.phone,
        r.title,
        r.max_access_number AS maxAccessNumber,
        r.create_at AS createDate,
        r.gift_number AS giftNumber,
        r.point_number AS pointNumber,
        r.duration AS duration,
        r.praise_number AS praiseNumber,
        r.finish_at AS finishDate,
        r.platform AS platform,
        r.app_version AS appVersion,
        r.channel AS channel,
        r.uv as uv,
        r.chat_count as userChatCount,
        r.anchor_chat_count as anchorChatCount
        FROM room r
        LEFT JOIN ruser ru ON ru.id = r.creator_id
        <where>
            r.creator_id IS NOT NULL AND r.praise_number > 0
            <choose>
                <when test="userKey != null">
                    <if test="userKey == 1">
                        <if test="userKeyword != null and userKeyword != ''">
                            AND ru.id = #{userKeyword}
                        </if>
                    </if>
                    <if test="userKey == 2">
                        <if test="userKeyword != null and userKeyword != ''">
                            AND ru.username LIKE CONCAT('%',#{userKeyword},'%')
                        </if>
                    </if>
                    <if test="userKey == 3">
                        <if test="userKeyword != null and userKeyword != ''">
                            AND ru.name LIKE CONCAT('%',#{userKeyword},'%')
                        </if>
                    </if>
                    <if test="userKey == 4">
                        <if test="userKeyword != null and userKeyword != ''">
                            AND (ru.band_phone=#{userKeyword} or ru.username=#{userKeyword} or ru.phone LIKE CONCAT('%',#{userKeyword},'%'))
                        </if>
                    </if>
                </when>
            </choose>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND DATE_FORMAT(r.create_at, '%Y-%m-%d')  >= #{startDate,jdbcType=TIMESTAMP} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND DATE_FORMAT(r.create_at, '%Y-%m-%d')  <= #{endDate,jdbcType=TIMESTAMP} ]]>
            </if>
            <if test="platform !=null and platform != ''">
                    AND r.platform = #{platform}
            </if>
            <if test="appVersion !=null and appVersion != ''">
                    AND r.app_version = #{appVersion}
            </if>
            <if test="channel !=null and channel != ''">
                    AND r.channel = #{channel}
            </if>
        </where>
        ORDER BY r.id DESC
    </select>

    <select id="selectLiveDataByLiveActivityId" resultType="map" parameterType="java.lang.Long">
        SELECT COUNT(*) AS liveNumber ,IFNULL(SUM(max_access_number),0) AS maxAccessNumber,IFNULL(SUM(uv),0) AS uv FROM `room`
        WHERE live_activity_id = #{liveActivityId,jdbcType=BIGINT};
    </select>
    
    <select id="selectLiveDataByLiveActivityIdAndUserId" resultType="map" parameterType="map">
        SELECT SUM(r.max_access_number) AS maxAccessNumber FROM `room` r 
        WHERE r.live_activity_id = #{liveActivityId,jdbcType=BIGINT}
        <if test="userId != null and userId != ''">
            AND r.creator_id = #{userId,jdbcType=BIGINT}
        </if>
    </select>
    
    <select id="findSenderCount" resultType="Long" parameterType="map">
        SELECT count(distinct cr.sender) AS senderCount FROM `consume_record` cr ,room r,gift g
        WHERE cr.room_id=r.id and cr.gift_id=g.id and r.live_activity_id = #{liveActivityId,jdbcType=BIGINT}
        <if test="is_exclusive != null and is_exclusive != ''">
            AND g.is_exclusive = #{is_exclusive,jdbcType=INTEGER}
        </if>
    </select>
    <select id="findSumDPByLiveActivityId" resultType="Long" parameterType="map">
        SELECT sum( cr.diamond_count) AS dc FROM `consume_record` cr ,room r,gift g
        WHERE cr.room_id=r.id and cr.gift_id=g.id and r.live_activity_id = #{liveActivityId,jdbcType=BIGINT}
        <if test="is_exclusive != null and is_exclusive != ''">
            AND g.is_exclusive = #{is_exclusive,jdbcType=INTEGER}
        </if>
    </select>

    <!--当日直播人数-->
    <select id="selectDailyDataLiveCount" resultType="java.lang.Long" parameterType="map">
        SELECT COUNT(DISTINCT r.creator_id)
        FROM room r
        LEFT JOIN ruser u ON u.id = r.creator_id
        <where>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND r.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND r.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="platform !=null and platform != ''">
                AND r.platform = #{platform,jdbcType=VARCHAR}
            </if>
            <if test="regPlatform !=null and regPlatform != ''">
                AND u.reg_platform = #{regPlatform,jdbcType=VARCHAR}
            </if>
            <if test="appVersion !=null and appVersion != ''">
                AND r.app_version = #{appVersion,jdbcType=VARCHAR}
            </if>
            <if test="channel !=null and channel != ''">
                    AND r.channel = #{channel}
            </if>
        </where>
    </select>

    <!--当日新注册开播人数-->
    <select id="selectDailyDataNewRegLiveCount" resultType="java.lang.Long" parameterType="map">
        SELECT COUNT(DISTINCT a.creator_id) FROM anchor a
        LEFT JOIN ruser u ON u.id = a.creator_id
        LEFT JOIN room r ON r.creator_id = u.id
        <where>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND a.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND a.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND u.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND u.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="platform !=null and platform != ''">
                AND r.platform = #{platform,jdbcType=VARCHAR}
            </if>
            <if test="regPlatform !=null and regPlatform != ''">
                AND u.reg_platform = #{regPlatform,jdbcType=VARCHAR}
            </if>
            <if test="appVersion !=null and appVersion != ''">
                AND r.app_version = #{appVersion,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <!--当日新开播人数-->
    <select id="selectDailyDataNewLiveCount" resultType="java.lang.Long" parameterType="map">
        SELECT COUNT(DISTINCT a.creator_id) FROM anchor a
        LEFT JOIN ruser u ON u.id = a.creator_id
        LEFT JOIN room r ON r.creator_id = u.id
        <where>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND a.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND a.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="platform !=null and platform != ''">
                AND r.platform = #{platform,jdbcType=VARCHAR}
            </if>
            <if test="regPlatform !=null and regPlatform != ''">
                AND u.reg_platform = #{regPlatform,jdbcType=VARCHAR}
            </if>
            <if test="appVersion !=null and appVersion != ''">
                AND r.app_version = #{appVersion,jdbcType=VARCHAR}
            </if>
        </where>
    </select>

    <!--当日直播人数-->
    <select id="selectDailyDataLiveDetailCount" resultType="com.busap.vcs.data.model.LiveDayDetailDisplay" parameterType="map">
        SELECT DATE_FORMAT(t.create_at, "%H:00" ) AS time,SUM(t.count) as count from (
        SELECT COUNT(DISTINCT r.creator_id) as count,r.creator_id,r.create_at
        FROM room r
        LEFT JOIN ruser u ON u.id = r.creator_id
        <where>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND r.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND r.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="platform !=null and platform != ''">
                AND r.platform = #{platform,jdbcType=VARCHAR}
            </if>
            <if test="regPlatform !=null and regPlatform != ''">
                AND u.reg_platform = #{regPlatform,jdbcType=VARCHAR}
            </if>
            <if test="appVersion !=null and appVersion != ''">
                AND r.app_version = #{appVersion,jdbcType=VARCHAR}
            </if>
        </where>
        GROUP BY DATE_FORMAT(r.create_at, "%Y-%m-%d %H" )
        ) t
        GROUP BY DATE_FORMAT(t.create_at, "%Y-%m-%d %H" )
    </select>

    <!--当日直播人数-->
    <select id="selectDailyDataLiveTotalCount" resultType="java.lang.Long" parameterType="map">
        SELECT COUNT(DISTINCT r.creator_id)
        FROM room r
        LEFT JOIN ruser u ON u.id = r.creator_id
        <where>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND r.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND r.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="platform !=null and platform != ''">
                AND r.platform = #{platform,jdbcType=VARCHAR}
            </if>
            <if test="regPlatform !=null and regPlatform != ''">
                AND u.reg_platform = #{regPlatform,jdbcType=VARCHAR}
            </if>
            <if test="appVersion !=null and appVersion != ''">
                AND r.app_version = #{appVersion,jdbcType=VARCHAR}
            </if>
            <if test="channel !=null and channel != ''">
                AND r.channel = #{channel}
            </if>
        </where>
    </select>

    <select id="selectDistinctLiveNumByLiveActivityId" resultType="java.lang.Long" parameterType="java.lang.Long">
        SELECT count(DISTINCT creator_id) from room where live_activity_id = #{liveActivityId,jdbcType=BIGINT}
    </select>


    <select id="selectUserLiveDurationInfo" resultType="com.busap.vcs.data.model.OrganizationAnchorDisplay" parameterType="map">
        SELECT
        t.creator_id AS userId,
        IFNULL(SUM(t.duration),0) AS totalDuration,
        IFNULL(SUM(t.days),0) AS days,
        IFNULL(SUM(t.pointNumber),0) AS pointNumber
        FROM
        (
        SELECT
        CASE
        WHEN(sum(r.duration)>=3600000) THEN 1
        ELSE 0
        END AS days,
        sum(r.duration) as duration,
        r.creator_id,
        sum(r.point_number) as pointNumber,
        DATE_FORMAT(r.create_at, "%Y-%m-%d")
        FROM
        room r
        LEFT JOIN ruser u ON u.id = r.creator_id
        <where>
            <if test="userId != null">
                AND u.id = #{userId,jdbcType=BIGINT}
            </if>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND r.create_at >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND r.create_at <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
        </where>
        GROUP BY r.creator_id,DATE_FORMAT(r.create_at, "%Y-%m-%d" )
        ) t
    </select>


    <sql id="page_sql">LIMIT #{pageStart},#{pageSize}</sql>
    <!--一周首播新人-->
    <select id="selectPeriodFirstTimeLiveUser" resultType="java.lang.String" parameterType="map">
        SELECT
        t.creator_id AS userId
        FROM
        (
        SELECT r.creator_id,r.id,MIN(r.create_at) AS createTime
        FROM `room` AS r
        GROUP BY r.creator_id
        ) t
        WHERE
        TIMESTAMPDIFF(HOUR,t.createTime,now()) <![CDATA[ < ]]> #{hours,jdbcType=INTEGER}
        ORDER BY t.id DESC
        <!--<include refid="page_sql"/>-->
        <!--<where>
            <if test="startDate !=null and startDate != ''">
                <![CDATA[ AND t.createTime >= #{startDate,jdbcType=VARCHAR} ]]>
            </if>
            <if test="endDate !=null and endDate != ''">
                <![CDATA[ AND t.createTime <= #{endDate,jdbcType=VARCHAR} ]]>
            </if>
        </where>-->
    </select>

    <select id="selectRoomByPersistentId" resultType="com.busap.vcs.data.entity.Room" parameterType="map">
      SELECT
      id,
      creator_id AS creatorId,
      create_at AS createDate,
      duration,
      room_pic AS roomPic,
      title,
      max_access_number AS maxAccessNumber
      FROM room
      WHERE persistent_id = #{persistentId,jdbcType=VARCHAR}
      LIMIT 1
    </select>
    
    <update id="endLive" parameterType="map">
    	update room set modify_at=now(),finish_at=#{finishTime},duration=#{duration},chat_count=#{chatCount},
	    	anchor_chat_count=#{anchorChatCount},max_access_number=#{maxAccessNumber},normal_user_count=#{normalUserCount},
	    	praise_number=#{praiseNumber},mj_praise_number=0,
			status=0,uv=#{uv},gift_number=#{giftNumber},point_number=#{pointNumber} 
		where id=#{roomId}
    </update>

    <select id="selectRoomListByUserId" resultType="com.busap.vcs.data.entity.Room" parameterType="map">
      SELECT
      id,
      title,
      create_at AS createDateStr,
      finish_at AS finishDate
      FROM
      room
      WHERE
      creator_id =  #{userId,jdbcType=BIGINT}
      <if test="createDate != null and createDate != ''">
          AND
      </if>
      <if test="endDate != null and endDate != ''">
          AND
      </if>
      ORDER BY id DESC
    </select>

</mapper>
