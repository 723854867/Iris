<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.busap.vcs.data.mapper.GiftDao">
    <resultMap id="BaseResultMap" type="com.busap.vcs.data.entity.Gift">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="create_at" property="createDateStr" jdbcType="TIMESTAMP"/>
        <result column="creator_id" property="creatorId" jdbcType="BIGINT"/>
        <result column="data_from" property="dataFrom" jdbcType="VARCHAR"/>
        <result column="modify_at" property="modifyDate" jdbcType="TIMESTAMP"/>
        <result column="effect_file_url" property="effectFileUrl" jdbcType="VARCHAR"/>
        <result column="effect_type" property="effectType" jdbcType="INTEGER"/>
        <result column="gift_icon_url" property="giftIconUrl" jdbcType="VARCHAR"/>
        <result column="gift_purpose" property="giftPurpose" jdbcType="BIT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="point" property="point" jdbcType="INTEGER"/>
        <result column="price" property="price" jdbcType="INTEGER"/>
        <result column="state" property="state" jdbcType="BIT"/>
        <result column="weight" property="weight" jdbcType="DOUBLE"/>
        <result column="marker_state" property="markerState" jdbcType="CHAR"/>
        <result column="is_free" property="isFree" jdbcType="BIT"/>
        <result column="free_count" property="freeCount" jdbcType="INTEGER"/>
        <result column="loop_support" property="loopSupport" jdbcType="INTEGER"/>
        <result column="is_exclusive" property="isExclusive" jdbcType="BIT"/>
        <result column="screenshot_support" property="screenshotSupport" jdbcType="BIT"/>
        <result column="screenshot_number" property="screenshotNumber" jdbcType="INTEGER"/>
    </resultMap>
    <sql id="where_sql">
        <where>
            <if test="id !=null">
                AND id = #{id,jdbcType=BIGINT}
            </if>
            <if test="name !=null and name != ''">
                AND name LIKE CONCAT('%',#{name,jdbcType=VARCHAR},'%')
            </if>
            <if test="giftPurpose !=null">
                AND gift_purpose = #{giftPurpose,jdbcType=BIT}
            </if>
            <if test="effectType !=null">
                AND effect_type = #{effectType,jdbcType=INTEGER}
            </if>
            <if test="state !=null">
                AND state = #{state,jdbcType=BIT}
            </if>
            <if test="markerState !=null and markerState !=''">
                AND marker_state = #{markerState,jdbcType=CHAR}
            </if>
            <if test="isFree !=null">
                AND is_free = #{isFree,jdbcType=BIT}
            </if>
            <if test="loopSupport !=null">
                AND loop_support = #{loopSupport,jdbcType=BIT}
            </if>
            <if test="isExclusive != null">
                AND is_exclusive = #{isExclusive,jdbcType=BIT}
            </if>
            <if test="screenshotSupport != null">
                AND screenshot_support = #{screenshotSupport,jdbcType=BIT}
            </if>
        </where>
    </sql>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    delete from gift
    where id = #{id,jdbcType=BIGINT}
  </delete>
    <insert id="insert" parameterType="com.busap.vcs.data.entity.Gift" useGeneratedKeys="true" keyProperty="id">
    insert into gift (id, create_at, creator_id, 
      data_from, modify_at, effect_file_url, 
      effect_type, gift_icon_url, gift_purpose, 
      name, point, price, 
      state, weight, marker_state,is_free,free_count,loop_support,is_exclusive,screenshot_support,
      screenshot_number)
      values (#{id,jdbcType=BIGINT}, #{createDateStr,jdbcType=TIMESTAMP}, #{creatorId,jdbcType=BIGINT},
      #{dataFrom,jdbcType=VARCHAR}, #{modifyDate,jdbcType=TIMESTAMP}, #{effectFileUrl,jdbcType=VARCHAR},
      #{effectType,jdbcType=INTEGER}, #{giftIconUrl,jdbcType=VARCHAR}, #{giftPurpose,jdbcType=BIT},
      #{name,jdbcType=VARCHAR}, #{point,jdbcType=INTEGER}, #{price,jdbcType=INTEGER},
      #{state,jdbcType=BIT}, #{weight,jdbcType=DOUBLE}, #{markerState,jdbcType=CHAR},#{isFree,jdbcType=BIT},
      #{freeCount,jdbcType=INTEGER},#{loopSupport,jdbcType=INTEGER},#{isExclusive,jdbcType=BIT},
      #{screenshotSupport,jdbcType=BIT},#{screenshotNumber,jdbcType=INTEGER}
      )
  </insert>
    <update id="updateByPrimaryKey" parameterType="com.busap.vcs.data.entity.Gift">
        update gift
        <set>
            <if test="id != null">
                id = #{id,jdbcType=BIGINT},
            </if>
            <if test="name != null and name != ''">
                name = #{name,jdbcType=VARCHAR},
            </if>
            <if test="createDateStr != null">
                create_at = #{createDateStr,jdbcType=TIMESTAMP},
            </if>
            <if test="creatorId != null">
                creator_id = #{creatorId,jdbcType=INTEGER},
            </if>
            <if test="dataFrom != null">
                data_from = #{dataFrom,jdbcType=VARCHAR},
            </if>
            <if test="modifyDate != null">
                modify_at = now(),
            </if>
            <if test="effectFileUrl != null and effectFileUrl != ''">
                effect_file_url = #{effectFileUrl,jdbcType=VARCHAR},
            </if>
            <if test="effectType != null">
                effect_type = #{effectType,jdbcType=INTEGER},
            </if>
            <if test="giftIconUrl != null and giftIconUrl != ''">
                gift_icon_url = #{giftIconUrl,jdbcType=VARCHAR},
            </if>
            <if test="giftPurpose != null">
                gift_purpose = #{giftPurpose,jdbcType=BIT},
            </if>
            <if test="point != null">
                point = #{point,jdbcType=INTEGER},
            </if>
            <if test="price != null">
                price = #{price,jdbcType=INTEGER},
            </if>
            <if test="state != null">
                state = #{state,jdbcType=BIT},
            </if>
            <if test="weight != null">
                weight = #{weight,jdbcType=DOUBLE},
            </if>
            <if test="markerState != null">
                marker_state = #{markerState,jdbcType=CHAR},
            </if>
            <if test="isFree != null">
                is_free = #{isFree,jdbcType=BIT},
            </if>
            <if test="freeCount != null">
                free_count = #{freeCount,jdbcType=INTEGER},
            </if>
            <if test="loopSupport != null">
                loop_support = #{loopSupport,jdbcType=INTEGER},
            </if>
            <if test="isExclusive != null">
                is_exclusive = #{isExclusive,jdbcType=BIT},
            </if>
            <if test="screenshotSupport != null">
                screenshot_support = #{screenshotSupport,jdbcType=BIT},
            </if>
            <if test="screenshotNumber != null and screenshotNumber > 0">
                screenshot_number = #{screenshotNumber,jdbcType=INTEGER},
            </if>
            modify_at = now()
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
    select id, create_at, creator_id, data_from, modify_at, effect_file_url, effect_type, 
    gift_icon_url, gift_purpose, name, point, price, state, weight, marker_state,
    is_free,free_count,loop_support,is_exclusive,screenshot_support,screenshot_number
    from gift
    where id = #{id,jdbcType=BIGINT}
  </select>
    <select id="selectAll" resultMap="BaseResultMap" parameterType="com.busap.vcs.data.model.GiftDisplay">
    select id, create_at, creator_id, data_from, modify_at, effect_file_url, effect_type, 
    gift_icon_url, gift_purpose, name, point, price, state, weight, marker_state,
        is_free,free_count,loop_support,is_exclusive,screenshot_support,screenshot_number
    from gift
        <include refid="where_sql"/>
        <choose>
            <when test="order != '' and order != null">ORDER BY #{sort} #{order}</when>
            <otherwise>ORDER BY weight DESC</otherwise>
        </choose>
  </select>
  
  <select id="sendGift" statementType="CALLABLE" resultType="Integer">
    	 <![CDATA[
    	    {call proc_sendgift(
	            #{giftId,mode=IN,jdbcType=BIGINT},
	            #{number,mode=IN,jdbcType=INTEGER},
	            #{senderId,mode=IN,jdbcType=BIGINT},
	            #{recieverId,mode=IN,jdbcType=BIGINT},
	            #{roomId,mode=IN,jdbcType=BIGINT},
	            #{divideRate,mode=IN,jdbcType=DOUBLE},
	            #{appVersion,mode=IN,jdbcType=VARCHAR},
	            #{platform,mode=IN,jdbcType=VARCHAR},
	            #{channel,mode=IN,jdbcType=VARCHAR}
	        )}
	    ]]>
    </select>
    
    <select id="reCount" resultType="java.util.Map"> 
	    SELECT cr.reciever ,sum( cr.points) AS dc FROM `consume_record` cr ,room r,gift g
        WHERE cr.room_id=r.id and cr.gift_id=g.id and r.live_activity_id = #{liveActivityId,jdbcType=BIGINT} and  g.id in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
         group by cr.reciever order by dc desc
    </select>
  
</mapper>
