<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busap.vcs.data.mapper.ActivityDAO">

	<select id="getBanner" resultType="java.util.Map">
    	SELECT a.title,a.description,a.banner_pic as bannerPic,a.video_cover_pic as videoCoverPic,a.playkey from activity a where a.id=#{id};
    </select>

    <sql id="page">limit #{pageStart},#{pageSize}</sql>

    <select id="searchActivitys" resultType="java.util.Map">
    <![CDATA[
    	select a.id,a.title,a.cover,a.create_at,a.order_num,a.`status`,a.create_at
		from activity a 
	]]>
		<if test="groupType != null">
			where a.group_type=#{groupType}
		</if>
		order by a.order_num
		<include refid="page"/>
    </select>

    <select id="searchActivitysCount" resultType="Integer">
    	select count(id) from activity
    	<if test="groupType != null">
			where group_type=#{groupType}
		</if>
    </select>

    <select id="activityVideos" resultType="Integer">
    	<![CDATA[
    		select count(av.id) from activity_video av,video v where av.activityid=#{id} and v.id=av.videoid and v.flow_stat<>'delete'
    	]]>
    </select>
    <select id="activityUsers" resultType="Integer">
    	<![CDATA[
    		select count(u.id) from ruser u where u.type<>'majia' 
				and u.id in(select v.creator_id from video v,activity_video av where v.id=av.videoid and av.activityid=#{id})
		]]>
    </select>
    <select id="activityPraise" resultType="Integer">
    	select count(p.id) from praise p where p.video_id in (select av.videoid from activity_video av where av.activityid=#{id})		
    </select>
    <select id="activityEvaluations" resultType="Integer">
    	select count(e.id) from evaluation e where e.video_id in (select av.videoid from activity_video av where av.activityid=#{id})
    </select>


	<!--活动管理列表查询-->
	<sql id="where_sql">
		<where>
			<if test="id != null">
				AND a.id = #{id}
			</if>
			<if test="title !=null and title != ''">
				AND a.title like CONCAT('%',#{title},'%')
			</if>
			<if test="startTime !=null and startTime != ''">
				<![CDATA[ AND DATE_FORMAT(a.create_at, '%Y-%m-%d')  >= #{startTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="endTime !=null and endTime != ''">
				<![CDATA[ AND DATE_FORMAT(a.create_at, '%Y-%m-%d')  <= #{endTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="pStartTime !=null and pStartTime != ''">
				<![CDATA[ AND DATE_FORMAT(a.publish_time, '%Y-%m-%d')  >= #{pStartTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="pEndTime !=null and pEndTime != ''">
				<![CDATA[ AND DATE_FORMAT(a.publish_time, '%Y-%m-%d')  <= #{pEndTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="order_num !=null">
				AND a.order_num = #{orderNum}
			</if>
			<if test="status !=null">
				AND a.status = #{status}
			</if>
			<if test="groupType !=null">
				AND a.group_type = #{groupType}
			</if>
			<if test="source != null and source != ''">
				AND a.source = #{source}
			</if>
		</where>
	</sql>

	<select id="selectActivities" parameterType="java.util.Map" resultType="com.busap.vcs.data.model.ActivityDisplay">
		SELECT
		a.id,
		a.title,
		a.cover,
		a.create_at AS createDate,
		a.order_num,
		a.`status`,
		/*b.avCount,
		c.pCount,
		d.eCount,
		e.rCount,*/
		a.playkey,
		a.banner_pic AS bannerPic,
		a.video_cover_pic AS videoCoverPic,
		a.create_at AS createDateStr,
		a.group_type AS groupType,
		a.description,
		a.source
		FROM activity a
		/*LEFT JOIN (
		SELECT av.activityid,COUNT(*) AS avCount FROM activity_video av
		LEFT JOIN video v ON v.id = av.videoid WHERE <![CDATA[ v.flow_stat<>'delete' ]]> GROUP BY av.activityid
		) b ON b.activityid = a.id
		LEFT JOIN (
		SELECT av.activityid,COUNT(1) AS pCount from praise p
		LEFT JOIN activity_video av ON av.videoid = p.video_id GROUP BY av.activityid
		) c ON c.activityid = a.id
		LEFT JOIN (
		SELECT av.activityid,COUNT(1) AS eCount FROM evaluation e
		LEFT JOIN activity_video av ON av.videoid = e.video_id GROUP BY av.activityid
		) d ON d.activityid = a.id
		LEFT JOIN (
		SELECT t.activityid,COUNT(t.id) AS rCount FROM (
		SELECT av.activityid,r.id FROM video v
		LEFT JOIN ruser r ON r.id = v.creator_id AND <![CDATA[ r.type<>'majia' ]]>
		LEFT JOIN activity_video av ON av.videoid = v.id WHERE -- av.activityid=8 AND
		r.id IS NOT NULL GROUP BY r.id,av.activityid ORDER BY av.activityid
		) t GROUP BY t.activityid
		) e ON e.activityid = a.id*/
		<include refid="where_sql"/>
		ORDER BY a.order_num
<!--		<if test="pageStart != null || pageSize != null">
			<include refid="page"/>
		</if>-->
	</select>

<!--	<select id="selectActivityCount" resultType="java.lang.Integer" parameterType="map">
		SELECT
		COUNT(1)
		FROM activity a
		<include refid="where_sql"/>
	</select>-->

	<insert id="insert" parameterType="com.busap.vcs.data.entity.Activity" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO activity
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="title != null and title != ''">
				title,
			</if>
			<if test="cover != null and cover != ''">
				cover,
			</if>
			<if test="createDateStr != null">
				create_at,
			</if>
			<if test="creatorId != null">
				creator_id,
			</if>
			<if test="modifyDate != null">
				modify_at,
			</if>
			<if test="description != null and description != ''">
				description,
			</if>
			<if test="order_num != null">
				order_num,
			</if>
			<if test="dataFrom != null and dataFrom != ''">
				data_from,
			</if>
			<if test="groupType != null">
				group_type,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="bannerPic != null and bannerPic != ''">
				banner_pic,
			</if>
			<if test="videoCoverPic != null and videoCoverPic != ''">
				video_cover_pic,
			</if>
			<if test="playkey != null and playkey != ''">
				playkey,
			</if>
			<if test="bannerDescription != null and bannerDescription != ''">
				banner_description,
			</if>
			<if test="tags != null and tags != ''">
				tags,
			</if>
			<if test="rusers != null and rusers != ''">
				rusers,
			</if>
			<if test="vips != null and vips != ''">
				vips,
			</if>
			<if test="source != null and source != ''">
				source,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="title != null and title != ''">
				#{title,jdbcType=VARCHAR},
			</if>
			<if test="cover != null and cover != ''">
				#{cover,jdbcType=VARCHAR},
			</if>
			<if test="createDateStr != null">
				#{createDateStr,jdbcType=TIMESTAMP},
			</if>
			<if test="creatorId != null">
				#{creatorId,jdbcType=INTEGER},
			</if>
			<if test="modifyDate != null">
				#{modifyDate,jdbcType=TIMESTAMP},
			</if>
			<if test="description != null and description != ''">
				#{description,jdbcType=VARCHAR},
			</if>
			<if test="order_num != null">
				#{order_num,jdbcType=INTEGER},
			</if>
			<if test="dataFrom != null and dataFrom != ''">
				#{dataFrom,jdbcType=VARCHAR},
			</if>
			<if test="groupType != null">
				#{groupType,jdbcType=INTEGER},
			</if>
			<if test="status != null">
				#{status,jdbcType=INTEGER},
			</if>
			<if test="bannerPic != null and bannerPic != ''">
				#{bannerPic,jdbcType=VARCHAR},
			</if>
			<if test="videoCoverPic != null and videoCoverPic != ''">
				#{videoCoverPic,jdbcType=VARCHAR},
			</if>
			<if test="playkey != null and playkey != ''">
				#{playkey,jdbcType=VARCHAR},
			</if>
			<if test="bannerDescription != null and bannerDescription != ''">
				#{bannerDescription,jdbcType=VARCHAR},
			</if>
			<if test="tags != null and tags != ''">
				#{tags,jdbcType=VARCHAR},
			</if>
			<if test="rusers != null and rusers != ''">
				#{rusers,jdbcType=VARCHAR},
			</if>
			<if test="vips != null and vips != ''">
				#{vips,jdbcType=VARCHAR},
			</if>
			<if test="source != null and source != ''">
				#{source,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>

	<update id="update" parameterType="com.busap.vcs.data.entity.Activity">
		UPDATE activity
		<set>
			<if test="id != null">
				id = #{id,jdbcType=INTEGER},
			</if>
			<if test="title != null and title != ''">
				title = #{title,jdbcType=VARCHAR},
			</if>
			<if test="cover != null and cover != ''">
				cover = #{cover,jdbcType=VARCHAR},
			</if>
			<if test="createDateStr != null">
				createDateStr = #{createDateStr,jdbcType=TIMESTAMP},
			</if>
			<if test="creatorId != null">
				creatorId = #{creatorId,jdbcType=INTEGER},
			</if>
			<if test="modifyDate != null">
				modifyDate = #{modifyDate,jdbcType=TIMESTAMP},
			</if>
			<if test="description != null and description != ''">
				description = #{description,jdbcType=VARCHAR},
			</if>
			<if test="order_num != null">
				order_num = #{order_num,jdbcType=INTEGER},
			</if>
			<if test="dataFrom != null and dataFrom != ''">
				dataFrom = #{dataFrom,jdbcType=VARCHAR},
			</if>
			<if test="groupType != null">
				groupType = #{groupType,jdbcType=INTEGER},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="bannerPic != null and bannerPic != ''">
				bannerPic = #{bannerPic,jdbcType=VARCHAR},
			</if>
			<if test="videoCoverPic != null and videoCoverPic != ''">
				videoCoverPic = #{videoCoverPic,jdbcType=VARCHAR},
			</if>
			<if test="playkey != null and playkey != ''">
				playkey = #{playkey,jdbcType=VARCHAR},
			</if>
			<if test="bannerDescription != null and bannerDescription != ''">
				bannerDescription = #{bannerDescription,jdbcType=VARCHAR},
			</if>
			<if test="tags != null and tags != ''">
				tags = #{tags,jdbcType=VARCHAR},
			</if>
			<if test="rusers != null and rusers != ''">
				rusers = #{rusers,jdbcType=VARCHAR},
			</if>
			<if test="vips != null and vips != ''">
				vips = #{vips,jdbcType=VARCHAR},
			</if>
			<if test="source != null and source != ''">
				source = #{source,jdbcType=VARCHAR},
			</if>
		</set>
		WHERE id = #{id,jdbcType=BIGINT}
	</update>

	<update id="batchOnline" parameterType="java.util.List">
			UPDATE activity
		    	<set>
			    	status = 1
		  	    </set>
			WHERE id IN
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
                #{item.id,jdbcType=INTEGER}
            </foreach>
	</update>

    <update id="batchOffline" parameterType="java.util.List">
            UPDATE activity
            <set>
                status = 0
            </set>
            WHERE id IN
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
				   #{item.id,jdbcType=INTEGER}
            </foreach>
    </update>

    <select id="selectBatchOnline" resultType="com.busap.vcs.data.entity.Activity">
        SELECT
        id
        FROM
        activity
        WHERE id IN
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

	<delete id="deleteActivity" parameterType="Long">
		DELETE FROM activity
		WHERE id = #{id}
	</delete>

	<select id="selectByPrimaryKey" resultType="com.busap.vcs.data.entity.Activity" parameterType="Long">
		SELECT
		id,
		order_num
		FROM activity WHERE id = #{id}
	</select>

	<update id="updateSort" parameterType="java.util.Map">
		UPDATE activity
		<set>
			order_num= #{orderNum}
		</set>
		WHERE id = #{id}
	</update>

	<select id="selectActivityByOrderNum" parameterType="java.util.Map" resultType="com.busap.vcs.data.entity.Activity">
		SELECT
		id,
		order_num
		FROM
		activity
		<if test="ASC != '' and ASC != null">
			WHERE order_num <![CDATA[ > ]]> #{orderNum}
			ORDER BY order_num ASC
		</if>
		<if test="DESC != '' and DESC != null">
			WHERE order_num <![CDATA[ < ]]> #{orderNum}
			ORDER BY order_num DESC
		</if>
		<if test="MAX != '' and MAX != null">
			ORDER BY order_num DESC
		</if>
		LIMIT 1
	</select>

	<select id="selectActivityVideoCount" parameterType="java.util.Map" resultType="java.lang.Long">
		SELECT
		COUNT(*)
		FROM activity_video av
		LEFT JOIN video v ON v.id = av.videoid
		left JOIN ruser r ON r.id = v.creator_id
		WHERE r.type = #{type}
		AND v.flow_stat != 'delete'
		AND av.activityid = #{activityId}
	</select>

	<select id="selectActivityList" parameterType="java.util.Map" resultType="com.busap.vcs.data.entity.Activity">
		SELECT
		a.id,
		a.title,
		a.cover,
		a.create_at AS createDate,
		a.order_num,
		a.`status`,
		a.playkey,
		a.banner_pic AS bannerPic,
		a.video_cover_pic AS videoCoverPic,
		a.create_at AS createDateStr,
		a.group_type AS groupType,
		a.description,
		a.source
		FROM activity a
		<where>
			<if test="source != null and source !=''">
				<choose>
					<when test="source == 'android'">
						a.source = "android" OR a.source = "all"
					</when>
					<when test="source == 'ios'">
						a.source = "ios" OR a.source = "all"
					</when>
				</choose>
			</if>
			<if test="status != null and status !=''">
				a.status = #{status}
			</if>
		</where>
		ORDER BY a.order_num DESC,a.create_at DESC
		<include refid="page"/>
	</select>
	
	<select id="getLiveAndNormalActivitiesList" parameterType="java.util.Map"  resultType="java.util.HashMap">
       
		select id ,1 as type,order_num as orderNum,create_at as createAt from activity where status=1
		<if test="source != null and source !=''">
				<choose>
					<when test="source == 'android'">
						and (source = "android" OR source = "all")
					</when>
					<when test="source == 'ios'">
						and (source = "ios" OR source = "all")
					</when>
				</choose>
			</if>
		
		union all 
		
		select id,2 as type,order_num as orderNum,create_at as createAt from live_activity where status=1 and type=1 
		 
		order by orderNum asc,createAt desc
		<include refid="page"/>
    </select>

</mapper>