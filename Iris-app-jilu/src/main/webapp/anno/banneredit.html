<!DOCTYPE html>
<html>
<head>
<title>后台管理系统</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">
<script type="text/javascript" charset="UTF-8" src="../scripts/jquery-1.10.2.min.js"></script>
<script type="text/javascript" charset="UTF-8" src="../scripts/public.js"></script>
<script type="text/javascript" src="../scripts/islogin.js"></script>
<script type="text/javascript" charset="UTF-8" src="../bootstrap-3.3.5-dist/js/bootstrap-datetimepicker.js"></script>
<script type="text/javascript" charset="UTF-8" src="../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
<script type="text/javascript" charset="UTF-8" src="../bootstrap-3.3.5-dist/js/bootstrap-datetimepicker.zh-CN.js"></script>
<script type="text/javascript" charset="UTF-8" src="../bootstrap-fileinput-4.3.2/js/fileinput.min.js"></script>
<script type="text/javascript" charset="utf-8" src="../ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="../ueditor/ueditor.all.min.js"></script>
<link href="../bootstrap-3.3.5-dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="../bootstrap-3.3.5-dist/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
<link href="../bootstrap-fileinput-4.3.2/css/fileinput.min.css" rel="stylesheet" />
<link href="../css/dashboard.css" rel="stylesheet" />
<link href="../css/menu.css" rel="stylesheet" />
</head>
<body>
	<nav id="main-top" class="navbar navbar-inverse navbar-fixed-top">

	</nav>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2">
				<ul id="main-nav" class="main-nav nav nav-tabs nav-stacked" style="">
				</ul>
			</div>
			<div class="col-md-10">
				<h2 class="sub-header">新增发布</h2>
				<form role="form" onsubmit="save();return false;" enctype="mutipart/form-data" id="form">
					<div class="table-responsive">
						<label for="title">标题</label> <input type="text" class="form-control" id="title" name="title" placeholder="必填项,请输入标题" required="required" />
						<label for="summary">简介</label> <input type="text" class="form-control" id="summary" name="summary" placeholder="必填项,请输入简介" required="required" />
						<label class="control-label">选择封面图片<font color='red'>（*必填）</font></label>
							<input id="fmUrl" name="fmUrl" type="file" class="file"/>
						<label class="control-label">APP首页滚动图片<font color='red'>（如果要把该文章放入首页滚动，则该图片必传）</font></label>
							<input id="gdUrl" name="gdUrl" type="file" class="file"/>
						<label for="href">链接URL</label> <input type="text" class="form-control" id="href" name="href" placeholder="请输入链接URL" required="required"/>
						<div class="span7 text-center">
							<button type="submit" class="btn btn-primary" >保存</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="../scripts/menu.js"></script>
	<script type="text/javascript">
	$(document).ready(function(){
		var fmUrl,gdUrl;
		var myLayoutTemplates = {
		        actions: '',
		};
		var id = getUrlParam("id");
		if(id!=null&&id!=""){
			$.ajax({
	            type: 'GET',
	            url: '/jilu/backstage',
	            data: { 'id': id,'action': 'banner_get' },
	            dataType: 'json',
	            async: false,
	            beforeSend: function () {
	            },
	            success: function (json) {
	            	//alert(json.toString());
	            	var data = json.data;
	            	$("#title").val(data["title"]);
	            	$("#summary").val(data["summary"]);
            		$("#href").val(data["href"]);
            		fmUrl = data['fmUrl'];
            		gdUrl = data['gdUrl'];
	            	
	            },
	            error: function () {
	                alert("数据加载失败");
	            }
	        });
		}
		$("#fmUrl").fileinput('destroy');
		$("#fmUrl").fileinput({
			language: 'zh', //设置语言
	        uploadUrl: '/jilu/backstage', // you must set a valid URL here else you will get an error
	        allowedFileExtensions : ['jpg', 'png','gif'],
	        showUpload: false, //是否显示上传按钮
	        maxFileSize: 2000,
	        maxFileCount: 5,
	        layoutTemplates: myLayoutTemplates,//显示的图片布局模版
	        msgFilesTooMany: "选择上传的文件数量 超过允许的最大数值！",
	        initialPreviewAsData: true,  
            initialPreviewFileType: 'image',  
	        initialPreview: [fmUrl]
		});
		
		 tActions = '<div class="file-actions">\n' +
	        '    <div class="file-footer-buttons">\n' +
	        '        {delete} {zoom} {other}' +
	        '    </div>\n' +
	        '    {drag}\n' +
	        '    <div class="file-upload-indicator" title="{indicatorTitle}">{indicator}</div>\n' +
	        '    <div class="clearfix"></div>\n' +
	        '</div>';
		
		var templates = {
				actions: tActions
		}
		$("#gdUrl").fileinput('destroy');
		$("#gdUrl").fileinput({
			language: 'zh', //设置语言
	        uploadUrl: '/jilu/backstage', // you must set a valid URL here else you will get an error
	        allowedFileExtensions : ['jpg', 'png','gif'],
	        showUpload: false, //是否显示上传按钮
	        maxFileSize: 2000,
	        maxFileCount: 5,
	        layoutTemplates: templates,//显示的图片布局模版
	        msgFilesTooMany: "选择上传的文件数量 超过允许的最大数值！",
	        initialPreviewAsData: true,  
            initialPreviewFileType: 'image',   
	        initialPreview: [gdUrl],
			initialPreviewConfig: [
		                       {
		                           url: '/jilu/backstage', // server delete action 
		                           extra: {id: id,action:'remove_gdimg'}
		                       }
		                   ]
		});
	});
	
		save = function()
		{
			var form = new FormData($("#form")[0]);
			var id = getUrlParam("id") == null?"":getUrlParam("id");
			if(id == "" || id == undefined || id == null){
				id = 0;
				var file_ = $("#fmUrl").val();
				if(file_ == "" || file_ == undefined || file_ == null){
					alert("请选择封面图片");
					return;
				}
			}
			form.append("id",id);
			form.append("action","banner_save");
			/* var title = $("#txtTitle").val();
			var summary = $("#txtSummary").val();
			var imgUrl = $("#txtImgUrl").val();
			var url = $("#txtUrl").val(); */
			$.ajax({
	            type: 'POST',
	            url: '/jilu/fileupload',
	            data: form,
	            dataType: 'json',
	            async: false,
	            contentType: false,  
	            processData: false,
	            beforeSend: function () {
					initLoading();
					showLoading("加载中。。。");
	            },	
	            success: function (json) {
	            	RemoveLoading();
	            	if(json.code=="0")
	            		window.location.href="bannerlist.html";
	            	else {
						alert(json.desc)
					}
	            },
	            error: function () {
	                alert("数据加载失败");
	            }
	        });
			
		}
	</script>
</body>
</html>