<!DOCTYPE html>
<html>
<head>
<title>后台管理系统</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">
<script type="text/javascript" src="../scripts/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="../scripts/public.js"></script>
<script type="text/javascript" src="../scripts/islogin.js"></script>
<script type="text/javascript" src="../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../bootstrap-3.3.5-dist/js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
<script type="text/javascript" src="../bootstrap-3.3.5-dist/js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
<link href="../bootstrap-3.3.5-dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="../bootstrap-3.3.5-dist/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
<link href="../css/dashboard.css" rel="stylesheet" />
<link href="../css/menu.css" rel="stylesheet" />
</head>
<body>
	<nav id="main-top" class="navbar navbar-inverse navbar-fixed-top">

	</nav>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-2">
				<ul id="main-nav" class="main-nav nav nav-tabs nav-stacked" style="">
				</ul>
			</div>
			<div class="col-md-10">
				<div class="form-inline">
				  <div class="form-group">
				    <h3 class="sub-header">公告发布</h3>
				  </div>
				  <a href="banneredit.html" class="btn btn-success">新增</a>
				</div>
				<form role="form">
					<div class="form-inline">
						<label for="organ">标题：</label> <input class="form-control" type="text"
							id="txtTitle" placeholder="标题">
						<button type="submit" class="btn btn-default" onclick="getData(1);return false;"><span class="glyphicon glyphicon-search"></span> 查询</button>
					</div>
					
					<div class="table-responsive">
						<table class="table table-striped">
							<thead>
								<tr>
									<th>序号</th>
									<th>标题</th>
									<th>图片</th>
									<th>url</th>
									<th>发布</th>
									<th width="240px">操作</th>
								</tr>
							</thead>
							<tbody id="list">
							</tbody>
						</table>
						<nav aria-label="Page navigation">
						  <ul class="pagination" id="pagecount">
						  </ul>
						</nav>
					</div>
				</form>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="../scripts/menu.js"></script>
	<script type="text/javascript">
	$(function() {
		getData(1);
	});
	
	var title='';
	var publishtxt='';
	var publishbutton='';
	getData=function(page) {
		title=$("#txtTitle").val();
        $.ajax({
            type: 'POST',
            url: '/jilu/backstage',
            data: { 'page': page, 'pageSize': pageSize,'title':title,'action': 'banner_list_get' },
            dataType: 'json',
            beforeSend: function () {
                //$("#dvList ul").append("<li id='loading'>loading...</li>");//显示加载动画
            },
            success: function (json) {
            	$("#list").empty();//清空数据区
            	var tr= "";
            	var list = json.data.list;
            	total = json.data.total; //总记录数
            	curPage = page; //当前页
                totalPage = Div(total, pageSize);
                $.each(list, function (index, array) { //遍历json数据列

                	tr+="<tr>";
                	tr+="<td>" + array['bannerId'] + "</td>";
                	tr+="<td>" + array['title'] + "</td>";
                	
                	tr+="<td>";
                	tr+="<a href='"+array['imgurl']+"' target='_blank'>查看</a>";
                	tr +="</td>";
                	
                	tr+="<td>";
                	tr+="<a href='"+array['href']+"' target='_blank'>查看</a>";
                	tr +="</td>";
                	
                	
                	if(array['ispublished']==1)
               		{
                		publishtxt="已发布";
                		publishbutton="取消发布";
               		}
                	else
               		{
                		publishtxt="未发布";
                		publishbutton="发布";
               		}
                	tr+="<td>" + publishtxt + "</td>";
                	
                	tr+="<td>" + array['pushcount'] + "</td>";
                	
                	tr+="<td>";
                	tr+="<a href='banneredit.html?id="+array['bannerId']+"' class='btn btn-info btn-xs'>编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;";
                	tr+="<a "+" class='btn btn-info btn-xs' onclick='publish("+array['bannerId']+")'>"+publishbutton+"</a>&nbsp;&nbsp;&nbsp;&nbsp;";
                	tr+="<a "+" class='btn btn-info btn-xs' onclick='push("+array['bannerId']+")'>推送</a>&nbsp;&nbsp;&nbsp;&nbsp;";
                	tr+="<a "+" class='btn btn-danger btn-xs' onclick='deleteData("+array['bannerId']+")'>删除</a>&nbsp;&nbsp;&nbsp;&nbsp;";
                	tr +="</td>";
                	
                	tr+="</tr>";
                });
                
                $("#list").append(tr);
            	//console.log(tr);
            	
            },
            complete: function () { //生成分页条
                getPageBar();
            },
            error: function () {
                alert("数据加载失败");
            }
        });
    }
	getPageBar=function() {
		if(totalPage>1)
		{
	        //页码大于最大页数
	        if (curPage > totalPage) curPage = totalPage;
	        //页码小于1
	        if (curPage < 1) curPage = 1;
	        pageStr = "<li class='disabled'><a href='javascript:void(0)'>共" + total + "条</a></li><li class='disabled'><a href='javascript:void(0)'>" + curPage + "/" + totalPage + "</a></li>";
	        //如果是第一页
	        if (curPage == 1) {
	            pageStr += "<li class='disabled'><a href='javascript:void(0)'>首页</a></li><li class='disabled'><a href='javascript:void(0)'>上一页</a></li>";
	        }
	        else {
	            pageStr += "<li><a href='javascript:void(0)' rel='1'>首页</a></li><li><a href='javascript:void(0)' rel='" + (curPage - 1) + "'>上一页</a></li>";
	        }
	        //如果是最后页
	        if (curPage >= totalPage) {
	            pageStr += "<li class='disabled'><a href='javascript:void(0)'>下一页</a></li><li class='disabled'><a href='javascript:void(0)'>尾页</a></li>";
	        }
	        else {
	            pageStr += "<li><a href='javascript:void(0)' rel='" + (parseInt(curPage) + 1) + "'>下一页</a></li><li><a href='javascript:void(0)' rel='" + totalPage + "'>尾页</a></li>";
	        }
	        $("#pagecount").html(pageStr);
		}
    }
	deleteData = function(id){
		if(confirm("确定要删除这条数据吗？")){
			$.ajax({
	            type: 'POST',
	            url: '/qydj/backstage',
	            data: { 'id': id , 'action': 'banner_del' },
	            dataType: 'json',
	            beforeSend: function () {
	                //$("#dvList ul").append("<li id='loading'>loading...</li>");//显示加载动画
	            },
	            success: function (json) {
	            	getData(curPage);
	            },
	            error: function () {
	                alert("数据加载失败");
	            }
	        });
		}
	}
	
	publish = function(id){
		if(confirm("确定要发布这条数据吗？")){
			$.ajax({
	            type: 'POST',
	            url: '/qydj/backstage',
	            data: { 'id': id , 'action': 'banner_publish' },
	            dataType: 'json',
	            beforeSend: function () {
	                //$("#dvList ul").append("<li id='loading'>loading...</li>");//显示加载动画
	            },
	            success: function (json) {
	            	getData(curPage);
	            },
	            error: function () {
	                alert("数据加载失败");
	            }
	        });
		}
	}
	
	push = function(id){
		if(confirm("确定要推送这条数据吗？")){
			$.ajax({
	            type: 'POST',
	            url: '/qydj/backstage',
	            data: { 'id': id , 'action': 'banner_push' },
	            dataType: 'json',
	            beforeSend: function () {
	                //$("#dvList ul").append("<li id='loading'>loading...</li>");//显示加载动画
	            },
	            success: function (json) {
	            	getData(curPage);
	            	alert("推送成功");
	            },
	            error: function () {
	                alert("推送失败");
	            }
	        });
		}
	}
</script>
</body>
</html>